/*!
 * lotivis.js v1.0.1
 * https://github.com/lukasdanckwerth/lotivis#readme
 * (c) 2021 lotivis.js Lukas Danckwerth
 * Released under the MIT License
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).lotivis={})}(this,(function(t){"use strict";function e(){let t;function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}t=[];let a=e();for(;t.indexOf(a)>=0;)a=e();return"id-"+a}class a{constructor(t){if(!t)throw"No parent specified.";this.selector=e(),this.parent=t}show(){this.element&&this.element.style("display","inline-block")}hide(){this.element&&this.element.style("display","none")}get isVisible(){return!!this.element&&"none"!==this.element.style("display")}}class s extends a{constructor(t){super(t);let e=this;this.element=t.append("button").attr("id",this.selector).on("click",(function(t){e.onClick&&e.onClick(t)}))}setText(t){this.element.text(t)}setFontAwesomeImage(t){this.element.html('<i class="fas fa-'+t+'"></i>')}onClick(t){}}class i{static getInstance(){return i.instance||(i.instance=new i),i.instance}getURL(){return new URL(window.location.href)}getBoolean(t,e=!1){let a=this.getURL().searchParams.get(t);return a?"true"===a:e}getString(t,e=""){return this.getURL().searchParams.get(t)||e}set(t,e){const a=this.getURL();!1===e?a.searchParams.delete(t):a.searchParams.set(t,e),window.history.replaceState(null,null,a),this.updateCurrentPageFooter()}setWithoutDeleting(t,e){const a=this.getURL();a.searchParams.set(t,e),window.history.replaceState(null,null,a),this.updateCurrentPageFooter()}clear(){const t=this.getURL(),e=t.protocol+t.host,a=new URL(e);window.history.replaceState(null,null,a),this.updateCurrentPageFooter()}updateCurrentPageFooter(){console.log("window.lotivisApplication: "+window.lotivisApplication),window.lotivisApplication.currentPage.updateFooter()}}i.language="language",i.page="page",i.query="query",i.searchViewMode="search-view-mode",i.chartType="chart-type",i.chartShowLabels="chart-show-labels",i.chartCombineStacks="chart-combine-stacks",i.contentType="content-type",i.valueType="value-type",i.searchSensitivity="search-sensitivity",i.startYear="start-year",i.endYear="end-year",i.showTestData="show-test-data";const r={greeting:"Hallo Welt","French Rap Corpus Visualization":"Französiche Rap Corpus Visualisierung",Version:"Version",Server:"Server",Search:"Suchen","Diachronic Data":"Diachronische Daten","Diatopic Data":"Diatopische Daten","Corpus Data":"Korpus Daten","Artists Data":"KünstlerInnen Daten","About the Project":"Über das Projekt","Click on URL to copy it to clipboard":"Klicken Sie auf die URL, um sie in die Zwischenablage zu kopieren",Tracks:"Lieder",Words:"Wörter","Words (Relative)":"Wörter (Relativ)",Types:"Typen","Types (Relative)":"Typen (Relativ)",true:"Ja",false:"Nein",Back:"Zurück","Loading...":"Laden...",Settings:"Einstellungen",Chart:"Diagramm",Close:"Schließen",Half:"Halb",Full:"Voll",from:"von",till:"bis",Relative:"Relativ",Absolute:"Absolut","Innovation List":"Innovations-Liste","View Mode":"Ansicht",Map:"Karte",Impress:"Impressum","Privacy Policy":"Datenschutzerklärung","Corpus loaded status":"Korpus geladen",Language:"Sprache"},n={greeting:"Hello World","French Rap Corpus Visualization":"French Rap Corpus Visualization",Version:"Version",Server:"Server",Search:"Search","Diachronic About":"Diachronic About","Corpus Metadata":"Corpus Metadata","Artists Metadata":"Artists Metadata",About:"About","Click on URL to copy it to clipboard":"Click on URL to copy it to clipboard",true:"Yes",false:"No",Back:"Back","Loading...":"Loading...",Impress:"Impress","Privacy Policy":"Privacy Policy","Corpus loaded status":"Corpus loaded status",Language:"Language"},o={greeting:"Bonjour le monde","French Rap Corpus Visualization":"Visualisation du corpus rap français ",Version:"Version",Server:"Serveur",Search:"Chercher","Diachronic About":"Diachronic About","Corpus Metadata":"Métadonnées du corpus ","Artists Metadata":"Métadonnées des artistes","About the Project":"À propos du projet","Click on URL to copy it to clipboard":"Cliquez sur l'URL pour la copier dans le presse-papiers",true:"Oui",false:"Non",Back:"Arrière","Loading...":"Chargement...",Close:"Conclure",Impress:"Impressionner","Privacy Policy":"Politique de confidentialité","Corpus loaded status":"Corpus chargé",Language:"Langue"},l={English:"en_EN",German:"de_DE",French:"fr_FR"};l.language=l.English,l.strings=n,l.setLanguage=function(t){switch(t){case l.English:l.strings=n;break;case l.German:l.strings=r;break;case l.French:l.strings=o}l.language=t},l.translate=function(t){return l.language===l.English?l.strings[t]||t:l.strings[t]||"=".repeat(t.length)};class h extends a{constructor(t){super(t),this.inputElements=[],this.element=t.append("form"),this.element.classed("radio-group",!0)}addOption(t,e){let a=this.element.append("input").attr("type","radio").attr("name",this.selector).attr("value",t).attr("id",t);this.element.append("label").attr("for",t).text(e||t);let s=this;return a.on("click",(function(t){s.onClick(t)})),a}setOptions(t){this.removeOptions(),this.inputElements=[];for(let e=0;e<t.length;e++){let a=t[e][0]||t[e].id,s=t[e][1]||t[e].translatedTitle,i=this.addOption(a,s);0===e&&i.attr("checked","true"),this.inputElements.push(i)}return this}setSelectedOption(t){for(let e=0;e<this.inputElements.length;e++){let a=this.inputElements[e];a.attr("value")===t&&a.attr("checked","true")}return this}removeOptions(){return this.element.selectAll("input").remove(),this.element.selectAll("label").remove(),this.inputElements=[],this}onClick(t){let e=t.target;if(!e)return;let a=e.value;return this.onChange?(this.onChange(a),this):void 0}onChange(t){}}class d extends a{constructor(t){super(t),this.element=this.parent.append("div").classed("card",!0),this.createHeader(),this.createBody(),this.createFooter()}createHeader(){this.header=this.element.append("div").classed("card-header",!0),this.headerRow=this.header.append("div").classed("row",!0),this.headerLeftComponent=this.headerRow.append("div").classed("col-3",!0),this.headerCenterComponent=this.headerRow.append("div").classed("col-6",!0),this.headerRightComponent=this.headerRow.append("div").classed("col-3 button-group",!0).classed("text-end",!0),this.titleLabel=this.headerLeftComponent.append("span").text(this.name)}createBody(){this.body=this.element.append("div").classed("card-body",!0),this.content=this.body.append("div").attr("id","content")}createFooter(){this.footer=this.element.append("div").classed("card-footer",!0),this.footerRow=this.footer.append("div").classed("row",!0),this.footerLeftComponent=this.footerRow.append("div").classed("col-6",!0),this.footerRightComponent=this.footerRow.append("div").classed("col-6",!0).classed("text-end",!0),this.footer.style("display","none")}}class c extends a{constructor(t){super(t),this.renderUnderground(t),this.renderContainer(),this.renderCard(),this.render(),this.renderCloseButton(),this.addCloseActionListeners()}render(){}renderUnderground(t){this.modalBackgroundId=e(),this.modalBackground=t.append("div").classed("popup-underground fade-in",!0).attr("id",this.modalBackgroundId)}renderContainer(){this.elementId=e(),this.element=this.modalBackground.append("div").classed("popup",!0).attr("id",this.elementId)}renderCard(){this.card=new d(this.element),this.card.element.classed("popup arrow arrow-right",!0)}renderCloseButton(){this.closeButton=new s(this.card.headerRightComponent),this.closeButton.element.classed("button-small",!0),this.closeButton.setText(l.translate("Close"))}addCloseActionListeners(){let t=[this.closeButton.selector,this.modalBackgroundId],e=this;this.modalBackground.on("click",(function(a){a&&a.target&&t.includes(a.target.id)&&e.dismiss()}))}willShow(){}didShow(){}show(){this.willShow&&this.willShow(),this.getUnderground().style.display="block",this.didShow&&this.didShow()}willDismiss(){}willRemoveDOMElement(){}dismiss(){this.willDismiss&&this.willDismiss(),this.getUnderground().style.display="none",this.willRemoveDOMElement&&this.willRemoveDOMElement(),this.getUnderground().remove()}getUnderground(){return document.getElementById(this.modalBackgroundId)}showUnder(t,e="center"){if(!t)return;let a=this.preferredSize(),s=this.calculateBottomCenter(t);s.x-="left"===e?s.width/2:"right"===e?a.width-s.width/2:a.width/2;let i=this.elementId,r=document.getElementById(i);r.style.position="absolute",r.style.width=a.width+"px",r.style.left=s.x+"px",r.style.top=s.y+"px",this.show()}showBigModal(){let t=this.elementId,e=document.getElementById(t),a=this.preferredSize();e.style.position="relative",e.style.margin="50px auto",e.style.width=a.width+"px",this.show()}preferredSize(){return{width:300,height:300}}calculateBottomCenter(t,e=!1){let a=t.getBoundingClientRect(),s=a.x+a.width/2,i=a.y+a.height;return e&&(s+=window.scrollX,i+=window.scrollY),{x:s,y:i,width:a.width,height:a.height}}}class p extends c{constructor(t){super(t),this.modalBackground.classed("popup-underground",!1).classed("modal-underground",!0)}render(){super.render(),this.renderRow()}renderRow(){this.row=this.card.body.append("div").classed("row",!0),this.content=this.row.append("div").classed("col-12 info-box-margin",!0)}loadContent(t){if(!t)return;console.log("url: "+t);let e=this.content;d3.text(t).then((function(t){console.log(t),e.html(t)})).catch((function(t){console.log(t),e.html(l.translate(""))}))}preferredSize(){return{width:800,height:600}}}class u{constructor(t,e="Unknown"){if(!t)throw"No application given.";this.title=e||"Unknown",this.application=t,this.element=t.element,this.renderHeader(),this.renderBody(),this.renderFooter(),t.makeContainerNormal(),document.title="FRC-Visualization - "+this.title}buildSubpage(){this.titleLabel=this.centerHeaderContainer.append("h1").text(this.title)}addRow(t=this.element){return this.addContainer(t,"row")}addContainer(t=this.element,e=""){return(t||this.element).append("div").classed(e,!0)}setTitle(t){this.title=t,this.titleLabel.text(t)}addSpace(t=this.element,e){return t.append("label").style("width",e+"px"),this}renderHeader(){this.headerRow=this.addRow(this.element).classed("row margin-bottom",!0),this.leftHeaderContainer=this.headerRow.append("div").classed("col-3",!0),this.centerHeaderContainer=this.headerRow.append("div").classed("col-6 text-center",!0),this.rightHeaderContainer=this.headerRow.append("div").classed("col-3 text-end button-group",!0),this.backButton=this.addBackButton(this.leftHeaderContainer)}renderBody(){this.row=this.addRow(this.element)}renderFooterRow(){this.footerRow=this.addRow(this.element).classed("footer",!0)}renderFooterLinks(){this.footerLinksContainer=this.footerRow.append("div").classed("col-12 text-center",!0),this.footerLinksContainer.append("a").text(l.translate("Impress")).on("click",function(){let t=`/html/impress-${l.language}.html`;this.presentModalPopup(t)}.bind(this)),this.footerLinksContainer.append("a").text(l.translate("Privacy Policy")).on("click",function(){let t=`/html/privacy-policy-${l.language}.html`;this.presentModalPopup(t)}.bind(this)),this.footerLinksContainer.append("a").text(l.translate("About the Project")).on("click",function(){let t=`/html/about-project-${l.language}.html`;this.presentModalPopup(t)}.bind(this))}presentModalPopup(t){let e=window.frcvApp.element,a=new p(e);a.loadContent(t),a.showBigModal()}renderFooterURL(){this.footerURLContainer=this.footerRow.append("div").classed("col-12 text-center",!0),this.footerURLContainer.append("br"),this.footerTooltipContainer=this.footerURLContainer.append("div").classed("tooltip",!0),this.footerURLLabel=this.footerTooltipContainer.append("a").append("samp").on("click",this.copyLocationToClipboard);let t=l.translate("Click on URL to copy it to clipboard");this.footerURLLabelTooltip=this.footerTooltipContainer.append("span").classed("tooltiptext",!0).text(t)}copyLocationToClipboard(){let t=window.location.href;navigator.clipboard.writeText(t).then((function(){console.log("Async: Copying to clipboard was successful!")}),(function(t){console.error("Async: Could not copy text: ",t)}))}renderFooterCorpusInfo(){this.footerCorpusInfoContainer=this.footerRow.append("div").classed("col-12 text-center",!0),this.footerDebugLabel=this.footerCorpusInfoContainer.append("samp"),this.updateFooterDebugInfo()}renderFooterLanguageInfo(){this.footerLanguageInfoContainer=this.footerRow.append("div").classed("col-12 text-center",!0),this.footerLanguageLabel=this.footerLanguageInfoContainer.append("samp"),this.footerLanguageRadioGroup=new h(this.footerLanguageInfoContainer),this.footerLanguageRadioGroup.setOptions([[l.English,"English"],[l.German,"German"],[l.French,"French"]]),this.footerLanguageRadioGroup.onChange=function(t){l.setLanguage(t),i.getInstance().set(i.language,t),Z.default.reloadPage()},this.footerLanguageRadioGroup.setSelectedOption(l.language)}renderFooter(){this.renderFooterRow(),this.renderFooterLinks(),this.renderFooterURL(),this.renderFooterCorpusInfo(),this.renderFooterLanguageInfo()}updateFooter(){this.updateFooterURL(),this.updateFooterDebugInfo()}updateFooterURL(){let t=i.getInstance().getURL();this.footerURLLabel.text(t)}updateFooterDebugInfo(){let t=l.translate("Corpus loaded status"),e=this.application.isCorpusLoaded(),a=l.translate(""+e);this.footerDebugLabel.text(`${t}: ${a}`)}addLoadingView(t=this.element){return t.loadingView=t.append("div").classed("loading-container",!0),t.loadingView.append("div").classed("loading-card",!0).text(l.translate("Loading...")),t.loadingView}showLoadingView(){this.loadingView=this.addLoadingView(this.element)}hideLoadingView(){this.loadingView&&this.loadingView.remove()}addBackButton(t=this.element){let e=new s(t);e.element.classed("back-button",!0),e.setText(l.translate("Back"));let a=this.application;return e.onClick=function(){a.showPage("main",!0)},e}showBackButton(){this.backButton.element.style("visibility","visible")}hideBackButton(){this.backButton.element.style("visibility","hidden")}loadCorpusIfNeeded(){if(this.willLoadCorpus(),this.application.isCorpusLoaded())this.didLoadCorpus();else{let t=this;this.application.loadCorpus((function(){t.didLoadCorpus()}))}}willLoadCorpus(){}didLoadCorpus(){this.updateFooterURL(),this.updateFooterDebugInfo()}}class g{constructor(t,e){this.id=t,this.title=e||t}get translatedTitle(){return l.translate(this.title)}}class m extends a{constructor(t){super(t),this.renderInput(),this.renderLabel()}renderInput(){let t=this;this.element=this.parent.classed("radio-group",!0).append("input").attr("type","checkbox").attr("id",this.selector).on("click",(function(e){if(!e.target)return;let a=e.target;t.onClick&&t.onClick(a.checked)}))}renderLabel(){this.label=this.parent.append("label").attr("for",this.selector).text("Unknown")}setText(t){return this.label.text(t),this}setChecked(t){return this.element.attr("checked",!0===t?t:null),this}onClick(t){console.log("onClick: "+t)}enable(){this.element.attr("disabled",null),this.label.style("color","black")}disable(){this.element.attr("disabled",!0),this.label.style("color","gray")}}class b extends c{preferredSize(){return{width:320,height:300}}render(){this.renderViewRadioGroup(),this.renderShowChartCheckbox(),this.renderShowMapCheckbox(),this.renderShowWordAboutCheckbox()}renderCard(){super.renderCard(),this.row=this.card.body.append("div").classed("row margin-top",!0)}renderViewRadioGroup(){this.viewRadioGroupLabel=this.row.append("div").classed("col-4 text-end",!0).text(l.translate("View Mode")+":"),this.viewRadioGroupContainer=this.row.append("div").classed("col-8",!0),this.viewRadioGroup=new h(this.viewRadioGroupContainer),this.viewRadioGroup.setOptions([new g("half","Half"),new g("full","Full")]),this.viewRadioGroup.onChange=function(t){this.searchPage&&(this.searchPage.setViewMode(t,!0),i.getInstance().set(i.searchViewMode,t))}.bind(this)}renderShowChartCheckbox(){this.showChartCheckboxLabel=this.row.append("div").classed("col-4 text-end",!0),this.showChartCheckboxContainer=this.row.append("div").classed("col-8",!0),this.showChartCheckbox=new m(this.showChartCheckboxContainer),this.showChartCheckbox.setText(l.translate("Show Chart")),this.showChartCheckbox.onClick=function(t){t?this.searchPage.showChart():this.searchPage.hideChart(),i.getInstance().setWithoutDeleting("show-chart",t)}.bind(this)}renderShowMapCheckbox(){this.showMapCheckboxLabel=this.row.append("div").classed("col-4 text-end",!0),this.showMapCheckboxContainer=this.row.append("div").classed("col-8",!0),this.showMapCheckbox=new m(this.showMapCheckboxContainer),this.showMapCheckbox.setText(l.translate("Show Map")),this.showMapCheckbox.onClick=function(t){t?this.searchPage.showMap():this.searchPage.hideMap(),i.getInstance().setWithoutDeleting("show-map",t)}.bind(this)}renderShowWordAboutCheckbox(){this.showWordAboutCheckboxLabel=this.row.append("div").classed("col-4 text-end",!0),this.showWordAboutCheckboxContainer=this.row.append("div").classed("col-8",!0),this.showWordAboutCheckbox=new m(this.showWordAboutCheckboxContainer),this.showWordAboutCheckbox.setText(l.translate("Show Word About")),this.showWordAboutCheckbox.onClick=function(t){t?this.searchPage.showWordAbout():this.searchPage.hideWordAbout(),i.getInstance().setWithoutDeleting("show-word-about",t)}.bind(this)}willShow(){super.willShow(),this.card.headerRow.append("h3").text(l.translate("Settings")),this.loadValues()}loadValues(){let t=this.searchPage;this.viewRadioGroup.setSelectedOption(t.viewMode),this.showChartCheckbox.setChecked(t.diachronicChartCard.isVisible),this.showMapCheckbox.setChecked(t.mapChartCard.isVisible),this.showWordAboutCheckbox.setChecked(t.wordAboutCard.isVisible)}}b.ViewMode={Half:"Half",Full:"Full"};class C{constructor(t,e,a){this.r=Math.round(t),this.g=Math.round(e),this.b=Math.round(a)}rgbString(){return`rgb(${this.r},${this.g},${this.b})`}colorAdding(t,e,a){return new C(this.r+t,this.g+e,this.b+a)}}function w(t,e){if(!Number.isInteger(t))return[C.stackColors[0]];let a=Math.max(e,5),s=C.stackColors[t%C.stackColors.length],i=s[0],r=s[1],n=(r.r-i.r)/a,o=(r.g-i.g)/a,l=(r.b-i.b)/a,h=[];for(let t=0;t<e;t++){let e=i.colorAdding(n*t,o*t,l*t);h.push(e)}return h}C.organgeLow=new C(250,211,144),C.organgeHigh=new C(229,142,38),C.redLow=new C(248,194,145),C.redHigh=new C(183,21,64),C.blueLow=new C(106,137,204),C.blueHigh=new C(12,36,97),C.lightBlueLow=new C(130,204,221),C.lightBlueHight=new C(10,61,98),C.greenLow=new C(184,233,148),C.greenHight=new C(7,153,146),C.stackColors=[[C.blueHigh,C.blueLow],[C.redHigh,C.redLow],[C.greenHight,C.greenLow],[C.organgeHigh,C.organgeLow],[C.lightBlueHight,C.lightBlueLow]];class f{}f.datasets=[{label:"Merde",stack:"Merde",data:[{label:2012,year:2012,yearTotal:100,value:12},{label:2013,year:2013,yearTotal:120,value:24},{label:2014,year:2014,yearTotal:140,value:12}]},{label:"Gucci",stack:"Gucci,Lacoste",data:[{label:2012,year:2012,yearTotal:100,value:5},{label:2013,year:2013,yearTotal:120,value:10},{label:2014,year:2014,yearTotal:140,value:15}]},{label:"Lacoste",stack:"Gucci,Lacoste",data:[{label:2012,year:2012,yearTotal:100,value:8},{label:2013,year:2013,yearTotal:120,value:8},{label:2014,year:2014,yearTotal:140,value:5}]},{label:"Nike",stack:"Nike,Puma",data:[{label:2012,year:2012,yearTotal:100,value:2},{label:2013,year:2013,yearTotal:120,value:4},{label:2014,year:2014,yearTotal:140,value:20}]},{label:"Puma",stack:"Nike,Puma",data:[{label:2012,year:2012,yearTotal:100,value:15},{label:2013,year:2013,yearTotal:120,value:30},{label:2014,year:2014,yearTotal:140,value:10}]}];class y extends a{constructor(t){if(super(t),!t)throw"No parent specified.";Object.getPrototypeOf(t)===String.prototype?(this.selector=t,this.element=d3.select("#"+t)):this.element=t,this.initialize(),this.update()}initialize(){this.width=1e3,this.height=600,this.defaultMargin=60,this.margin={top:this.defaultMargin,right:this.defaultMargin,bottom:this.defaultMargin,left:this.defaultMargin},this.datasets=[],this.presentedDatasetGroups=[],this.presentedStacks=[],this.labelColor=new C(155,155,155).rgbString(),this.type=y.ChartType.Bar,this.valueType="relative",this.isShowLabels=!1,this.isCombineStacks=!1,this.numberFormat=new Intl.NumberFormat("de-DE",{maximumFractionDigits:3}),i.getInstance().getBoolean(i.showTestData)&&(this.datasets=f.datasets)}set datasets(t){this._datasets=t,this._datasets.forEach((t=>t.isEnabled=!0))}update(){this.beforeDrawChart(),this.drawChart(),this.afterDrawChart()}beforeDrawChart(){this.configureChart(),this.calculatePresentedDatasets(),this.calculateListOfDatasetNames(),this.calculateListOfYears(),this.calculateListOfStacks(),this.calculateFlattenData(),this.calculateDatasetsPerYear(),this.calculateColors(),this.calculateDatasetStacks()}drawChart(){this.createSVG(),this.createGraph(),this.createScales(),this.createAxis(),this.renderAxis(),this.renderGrid(),this.renderStacks(),this.renderLegend()}configureChart(){this.renderMethod="Bar"===this.type?this.renderBars:this.renderLine;let t=this.margin;this.graphWidth=this.width-t.left-t.right,this.graphHeight=this.height-t.top-t.bottom}calculatePresentedDatasets(){this.presentedDatasets=this._datasets.filter((t=>t.isEnabled))}calculateDatasetStacks(){let t=this.presentedDatasets,e=this.presentedDatasetsPerYear;this.datasetStacks=this.listOfStacks.map((function(a,s){let i=t.filter((t=>t.stack===a)),r=i.map((t=>t.label)),n=i.map((t=>t.color)),o=d3.stack().keys(r)(e);return o.label=a,o.stack=a,o.colors=n,o})),this.allDatasetStacks=this.listOfAllStacks.map(function(t){let e=this._datasets.filter((e=>e.stack===t)),a=e.map((t=>t.label)),s=e.map((t=>t.color)),i=d3.stack().keys(a)(this.datasetsPerYear);return i.label=t,i.stack=t,i.colors=s,i}.bind(this))}calculateListOfStacks(){let t=d3.map(this.presentedDatasets,(t=>t.stack||t.label));this.listOfStacks=Array.from(new Set(t));let e=d3.map(this._datasets,(t=>t.stack||t.label));this.listOfAllStacks=Array.from(new Set(e))}calculateListOfYears(){this.presentedDatasets.length>0?this.listOfYears=this.presentedDatasets[0].data.map((t=>t.year)):this.listOfYears=[]}calculateListOfDatasetNames(){this.listOfDatasetNames=this.presentedDatasets.map((t=>t.label))}calculateDatasetsPerYear(){let t=this.flattenData;this.datasetsPerYear=this.listOfYears.map((function(e){let a={year:e};return t.filter((t=>t.year===e)).forEach((function(t){a[t.label]=t.value,a.total=t.yearTotal})),a})),this.presentedDatasetsPerYear=this.listOfYears.map((function(e){let a={year:e};return t.filter((t=>t.year===e)).filter((t=>!0===t.isEnabled)).forEach((function(t){a[t.label]=t.value,a.total=t.yearTotal})),a}))}calculateFlattenData(){this.flattenData=this._datasets.map((function(t){return t.data.forEach((function(e){e.label=t.label,e.stack=t.stack,e.key=t.stack,e.isEnabled=t.isEnabled})),t.data})).flat(1)}calculateColors(){for(let t=0;t<this.listOfAllStacks.length;t++){let e=this.listOfAllStacks[t],a=this._datasets.filter((t=>t.stack===e)),s=w(t,a.length);for(let t=0;t<s.length;t++)a[t].color=s[t]}}afterDrawChart(){}removeSVG(){this.element.selectAll("svg").remove()}createSVG(){this.removeSVG(),this.svg=this.element.append("svg").attr("preserveAspectRatio","xMidYMid meet").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("id",y.svgID),new Image}createGraph(){this.graph=this.svg.append("g").attr("width",this.graphWidth).attr("height",this.graphHeight).attr("transform",`translate(${this.margin.left}, ${this.margin.top})`)}createScales(){let t=d3.max(this.allDatasetStacks,(function(t){return d3.max(t,(function(t){let e=t.map((t=>t[1]));return d3.max(e)}))}));this.max=t,console.log("this.max: "+this.max),this.xChart=d3.scaleBand().domain(this.listOfYears).rangeRound([this.margin.left,this.width-this.margin.right]).paddingInner(.1),this.xDataset=d3.scaleBand().domain(this.listOfDatasetNames).rangeRound([0,this.xChart.bandwidth()]).padding(.05),this.xStack=d3.scaleBand().domain(this.listOfStacks).rangeRound([0,this.xChart.bandwidth()]).padding(.05),this.yChart=d3.scaleLinear().domain([0,t]).nice().rangeRound([this.height-this.margin.bottom,this.margin.top])}createAxis(){this.xAxisGrid=d3.axisBottom(this.xChart).tickSize(-this.graphHeight).tickFormat(""),this.yAxisGrid=d3.axisLeft(this.yChart).tickSize(-this.graphWidth).tickFormat("").ticks(20)}renderAxis(){this.svg.append("g").call(d3.axisBottom(this.xChart)).attr("transform",(t=>`translate(0,${this.height-this.margin.bottom})`)),this.svg.append("g").call(d3.axisLeft(this.yChart)).attr("transform",(t=>`translate(${this.margin.left},0)`))}renderGrid(){this.svg.append("g").attr("class","x axis-grid").attr("transform","translate(0,"+(this.height-this.margin.bottom)+")").attr("stroke","lightgray").attr("stroke-width","0.5").attr("opacity",.3).call(this.xAxisGrid),this.svg.append("g").attr("class","y axis-grid").attr("transform",`translate(${this.margin.left},0)`).attr("stroke","lightgray").attr("stroke-width","0.5").attr("opacity",.3).call(this.yAxisGrid)}renderStacks(){for(let t=0;t<this.datasetStacks.length;t++)this.renderBars(this.datasetStacks[t],t);if(!1!==this.isShowLabels)for(let t=0;t<this.datasetStacks.length;t++)this.renderBarLabels(this.datasetStacks[t],t)}renderBars(t,e){let a=this.xChart,s=this.yChart,i=this.xStack;this.svg.append("g").selectAll("g").data(t).enter().append("g").attr("fill",function(e,a){return this.isCombineStacks?t.colors[0].rgbString():t.colors[a].rgbString()}.bind(this)).selectAll("rect").data((function(t){return t})).enter().append("rect").attr("rx",function(){return this.isCombineStacks?0:4}.bind(this)).attr("x",(function(e){return a(e.data.year)+i(t.label)})).attr("y",(function(t){return s(t[1])})).attr("height",(function(t){return s(t[0])-s(t[1])})).attr("width",i.bandwidth())}renderBarLabels(t,e){let a=this.xChart,s=this.yChart,i=this.xStack,r=this.numberFormat,n=this.labelColor,o=t.length,l=0;this.svg.append("g").selectAll("g").data(t).enter().append("g").attr("fill",n).selectAll(".text").data((function(t){return t})).enter().append("text").attr("transform",(function(e){return`translate(${a(e.data.year)+i(t.label)+i.bandwidth()/2},${s(e[1])-5})rotate(-60)`})).attr("font-size",13).text((function(t,e){if(0===e&&(l+=1),l!==o)return;let a=t[1];return 0===a?"":r.format(a)}))}createLine(){if(0===this.datasetGroups.length)return debug("no datasets given to render lines.");for(let t=0;t<this.presentedDatasetGroups.length;t++){let e=this.presentedDatasetGroups[t],a=w(t,1)[0];e.color=a,this.renderLine(e)}}renderLine(t,e){this.graph.append("path").datum(t.data).attr("fill","none").attr("stroke",t.color.rgbString()).attr("stroke-width",3.5).attr("d",d3.line().x((t=>this.x0(t.year))).y((t=>this.y0(t.value))).curve(d3.curveMonotoneX));let a=this.graph.selectAll(".dot").data(t.data.filter((t=>t.value>0))).enter().append("circle").attr("r",6).attr("cx",(t=>this.x0(t.year))).attr("cy",(t=>this.y0(t.value))).attr("fill",t.color.rgbString()),s=this.element.append("div").attr("class","toolTip").style("z-index","9999");a.on("mousemove",(function(e,a){let i="<b>"+a.searchText+"</b> in <b>"+a.year+"</b><br>Abs.: <b>"+a.value+"</b><br>Rel.: <b>"+a.relativeValue+"</b><br>Total Year: <b>"+a.yearTotal+"</b>";s.style("left",e.pageX-20+"px").style("top",e.pageY-160+"px").style("padding","10px").style("background","none repeat scroll 0 0 #ffffff").style("position","absolute").style("border","1px solid "+t.color.rgbString()).style("display","inline-block").html(i)})).on("mouseout",(function(t){s.style("display","none")})),!0===this.isShowLabels&&this.renderLineLabels(t)}renderLineLabels(t){this.graph.selectAll(".text").data(t.data.filter((t=>t.value>0))).enter().append("text").attr("x",(t=>this.x0(t.year))).attr("y",(t=>this.y0(t.value))).attr("dy","-10").attr("text-anchor","middle").attr("font-size",15).attr("fill","gray").text((t=>this.numberFormat.format(t.value||0)))}renderLegend(){this.isCombineStacks?this.renderCombinedStacksLegend():this.renderNormalLegend()}renderNormalLegend(){let t=this._datasets,e=t.map((t=>t.label)),a=d3.scaleBand().domain(e).rangeRound([this.margin.left,this.width-this.margin.right]),s=this.graph.selectAll(".legend").data(t).enter(),i=s.append("text").attr("font-size",13).attr("x",(function(t){return a(t.label)-30})).attr("y",function(t){return this.graphHeight+50}.bind(this)).style("cursor","pointer").style("fill",function(t,e){return t.color.rgbString()}.bind(this)).text(function(t){return`${t.label} (${this.getSumForWord(t.label)})`}.bind(this));s.append("circle").attr("r",6).attr("cx",function(t){return a(t.label)-12-30}.bind(this)).attr("cy",function(t){return this.graphHeight+50-6+2}.bind(this)).style("cursor","pointer").style("stroke",function(t){return t.color.rgbString()}.bind(this)).style("fill",function(t){return t.isEnabled?t.color.rgbString():"white"}.bind(this)).style("stroke-width",2),i.on("click",function(t){if(!t||!t.target)return;if(!t.target.innerHTML)return;let e=t.target.innerHTML.split(" ")[0];this.toggleDataset(e)}.bind(this))}renderCombinedStacksLegend(){let t=this.listOfAllStacks;console.log("stackNames: "+t);let e=d3.scaleBand().domain(t).rangeRound([this.margin.left,this.width-this.margin.right]),a=this.graph.selectAll(".legend").data(t).enter();a.append("text").attr("font-size",13).attr("x",(function(t){return e(t)-30})).attr("y",function(t){return this.graphHeight+50}.bind(this)).style("cursor","pointer").style("fill",function(t,e){return w(e,1)[0].rgbString()}.bind(this)).text(function(t){return`${t} (${this.getSumForStack(t)})`}.bind(this)),a.append("circle").attr("r",6).attr("cx",function(t){return e(t)-12-30}.bind(this)).attr("cy",function(t){return this.graphHeight+50-6+2}.bind(this)).style("cursor","pointer").style("stroke",function(t,e){return w(e,1)[0].rgbString()}.bind(this)).style("fill",function(t,e){let a=w(e,1)[0];return t.isEnabled?a.rgbString():"white"}.bind(this)).style("stroke-width",2)}toggleDataset(t){let e=this._datasets.find((e=>e.label===t));e.isEnabled=!e.isEnabled,this.update()}getSumForWord(t){let e=this.flattenData.filter((e=>e.label===t)).map((t=>t.value));return this.numberFormat.format(d3.sum(e))}getSumForStack(t){let e=this.flattenData.filter((e=>e.stack===t)).map((t=>t.value));return d3.sum(e)}}y.svgID="chart-svg",y.ChartType={Bar:"Bar",Line:"Line"};class v extends c{render(){this.card.headerRow.append("h3").text(l.translate("Settings")),this.row=this.card.body.append("div").classed("row",!0),this.renderShowLabelsCheckbox(),this.renderCombineStacksCheckbox(),this.renderRadios()}renderShowLabelsCheckbox(){let t=this.row.append("div").classed("col-12 margin-top",!0);this.showLabelsCheckbox=new m(t),this.showLabelsCheckbox.setText(l.translate("Labels")),this.showLabelsCheckbox.onClick=function(t){this.diachronicChart.isShowLabels=t,this.diachronicChart.update(),i.getInstance().set(i.chartShowLabels,t)}.bind(this)}renderCombineStacksCheckbox(){let t=this.row.append("div").classed("col-12",!0);this.combineStacksCheckbox=new m(t),this.combineStacksCheckbox.setText(l.translate("Combine Stacks")),this.combineStacksCheckbox.onClick=function(t){this.diachronicChart.isCombineStacks=t,this.diachronicChart.update(),i.getInstance().set(i.chartCombineStacks,t)}.bind(this)}renderRadios(){let t=this.row.append("div").classed("col-12",!0);this.typeRadioGroup=new h(t),this.typeRadioGroup.setOptions([new g("bar","Bar"),new g("line","Line")]),this.typeRadioGroup.onChange=function(t){this.diachronicChart.type=t,this.diachronicChart.update(),i.getInstance().set(i.chartType,t)}.bind(this)}preferredSize(){return{width:240,height:600}}willShow(){this.loadValues()}loadValues(){this.showLabelsCheckbox.setChecked(this.diachronicChart.isShowLabels),console.log("this.diachronicChart.showLabels: "+this.diachronicChart.isShowLabels),this.combineStacksCheckbox.setChecked(this.diachronicChart.isCombineStacks),console.log("this.diachronicChart.combineGroups: "+this.diachronicChart.isCombineStacks),this.typeRadioGroup.setSelectedOption(this.diachronicChart.type)}}function x(t,e){console.log("selector: "+t);let a=document.querySelector(t);console.log("element: "+a),html2canvas(a).then((t=>{const a=document.createElement("a");a.setAttribute("download",e||"name"),a.href=t.toDataURL("image/jpg"),document.body.appendChild(a),a.click(),a.remove()}))}class k extends d{constructor(t,e){if(super(t),!t)throw"No selector specified.";this.selector=t,this.name=t,this.renderChart(),this.renderScreenshotButton(),this.renderMoreActionsButton(),this.applyURLParameters()}renderChart(){this.chart=new y(this.body),this.chart.margin.left=150,this.chart.margin.right=150}renderScreenshotButton(){this.chartID=e(),this.body.attr("id",this.chartID),this.screenshotButton=new s(this.headerRightComponent),this.screenshotButton.setText("Screenshot"),this.screenshotButton.element.classed("simple-button",!0),this.screenshotButton.element.html('<i class="fas fa-camera"></i>'),this.screenshotButton.onClick=function(t){x("#"+this.chartID,"my_image.jpg")}.bind(this)}renderMoreActionsButton(){this.moreActionButton=new s(this.headerRightComponent),this.moreActionButton.setText("More"),this.moreActionButton.element.classed("simple-button",!0),this.moreActionButton.element.html('<i class="fas fa-ellipsis-h"></i>'),this.moreActionButton.onClick=function(t){t&&t.target&&this.presentSettingsPopup()}.bind(this)}applyURLParameters(){this.chart.type=i.getInstance().getString(i.chartType,"bar"),this.chart.isShowLabels=i.getInstance().getBoolean(i.chartShowLabels,!1),this.chart.isCombineStacks=i.getInstance().getBoolean(i.chartCombineStacks,!1)}presentSettingsPopup(){let t=window.frcvApp,e=document.getElementById(this.moreActionButton.selector),a=new v(t.element);a.diachronicChart=this.chart,a.showUnder(e,"right")}}const S="de.beuth.frc-visualization.RecentSearchesLocalStorageKey";class L{constructor(){this.loadFromLocalStorage()}static getInstance(){return L.instance||(L.instance=new L),L.instance}append(t){this.removeIfExisting(t),this.insert(t),this.storeToLocalStorage()}insert(t){this.values.splice(0,0,t),this.removeDispensableValues()}removeIfExisting(t){let e=this.values.indexOf(t);e<0||this.values.splice(e,1)}removeDispensableValues(){if(this.values.length<100)return;let t=this.values.length-100;console.log("tooMuch: "+t),this.values.splice(100,t)}loadFromLocalStorage(){let t=localStorage.getItem(S);this.values=t?t.split("\n"):[]}storeToLocalStorage(){localStorage.setItem(S,this.values.join("\n"))}}class B extends a{constructor(t){if(super(t),!t)throw"No parent specified.";this.parent=t,this.datalistId=e(),this.element=t.append("input").classed("form-control form-control-sm",!0).attr("type","text").attr("placeholder","Search Word").attr("id",this.selector).attr("list",this.datalistId),this.datalist=t.append("datalist").attr("id",this.datalistId),this.element.on("keyup",function(t){"Enter"===t.key&&this.onEnter()}.bind(this)),this.element.on("change",function(t){this.onEnter()}.bind(this)),this.updateRecentSearches()}onEnter(){}startSearch(t){}getText(){return document.getElementById(this.selector).value}setText(t){document.getElementById(this.selector).value=t}updateRecentSearches(){this.datalist.selectAll("option").remove();let t=L.getInstance().values||[];this.datalist.selectAll("option").data(t).enter().append("option").attr("value",(t=>t))}}class D extends a{constructor(t){super(t),this.inputElements=[],this.selector=e(),this.element=t.append("div").classed("dropdown-container",!0),this.selectId=e(),this.renderLabel(),this.renderSelect()}renderLabel(){this.label=this.element.append("label").attr("for",this.selectId)}renderSelect(){let t=this;this.select=this.element.append("select").classed("form-control form-control-sm",!0).attr("id",this.selectId).on("change",(function(e){t.onClick(e)}))}addOption(t,e){return this.select.append("option").attr("id",t).attr("value",t).text(e)}setOptions(t){this.removeAllInputs();for(let e=0;e<t.length;e++){let a=t[e][0]||t[e].id,s=t[e][1]||t[e].translatedTitle,i=this.addOption(a,s);this.inputElements.push(i)}return this}removeAllInputs(){return this.element.selectAll("input").remove(),this}onClick(t){let e=t.target;if(!e)return;let a=e.value;return this.onChange?(this.onChange(a),this):void 0}onChange(t){return console.log("argument: "+t),"string"!=typeof t&&(this.onChange=t),this}setLabelText(t){return this.label.text(t),this}setOnChange(t){return this.onChange=t,this}setSelectedOption(t){return void 0!==this.inputElements.find((function(e){return e.attr("value")===t}))&&(this.value=t),this}set value(t){document.getElementById(this.selectId).value=t}get value(){return document.getElementById(this.selectId).value}}class A extends a{constructor(t){super(t),this.render()}render(){this.container=this.parent.append("div").classed("loading-container",!0),this.card=this.container.append("div").classed("loading-card",!0).text(l.translate("Loading..."))}show(){this.container.style("display","block")}hide(){this.container.style("display","none")}remove(){this.container.remove()}}class R extends c{constructor(t){super(t)}render(){super.render(),this.row=this.card.body.append("div").classed("row word-list",!0),this.card.headerRow.append("h3").text(l.translate("Innovation List"))}willShow(){super.willShow(),this.loadingView=new A(this.row),d3.text("/assets/InnovationList.txt").then(function(t){this.data=t.split("\n"),this.loadingView.remove(),this.dataDidLoad()}.bind(this)).catch(function(){this.data=[],this.dataDidLoad()}.bind(this))}preferredSize(){return{width:400,height:0}}dataDidLoad(){let t=this.data.map((function(t){let e=t.split(";");return{title:e[0],variations:e.join(",")}})),e=this;this.row.selectAll("div").append("div").data(t).enter().append("div").append("a").append("span").classed("representation",!0).text((t=>t.title)).append("span").classed("variations",!0).text((t=>"("+t.variations+")")).on("click",(function(t,a){e.searchCard.searchField.setText(""+a.variations),e.searchCard.startSearching(),e.dismiss()}))}}class I extends d{constructor(t){super(t),this.header.style("display","none"),this.row=this.body.append("div").classed("row margin-top",!0),this.renderSearchField(),this.renderCaseSensitiveDropdown(),this.renderRangeDropdown(),this.renderRelativeAbsolute(),this.renderFooterRow(),this.renderPresentInnovationListPopupButton(),this.renderSearchButton()}renderSearchField(){this.searchFieldContainer=this.row.append("div").classed("col-4",!0),this.searchField=new B(this.searchFieldContainer),this.searchField.onEnter=function(){this.startSearching()}.bind(this)}renderCaseSensitiveDropdown(){this.caseSensetiveGroupContainer=this.row.append("div").classed("col-2",!0),this.sensitivityDropdown=new D(this.caseSensetiveGroupContainer).setOptions([new g("case-sensitive","Case Sensitive"),new g("case-insensitive","Case Insensitive")]),this.sensitivityDropdown.label.text("Sensitivity"),this.sensitivityDropdown.onChange=function(t){i.getInstance().set(i.searchSensitivity,t),this.startSearching()}.bind(this)}renderRangeDropdown(){let t=[];for(let e=1995;e<=2020;e++)t.push([e,e]);this.yearStartContainer=this.row.append("div").classed("col-2",!0),this.yearStartDropdown=new D(this.yearStartContainer).setLabelText(l.translate("from")).setOptions(t).setSelectedOption(2e3).setOnChange(function(t){i.getInstance().set(i.startYear,t),this.startSearching()}.bind(this)),this.yearEndContainer=this.row.append("div").classed("col-2",!0),this.yearEndDropdown=new D(this.yearEndContainer).setLabelText(l.translate("till")).setOptions(t).setSelectedOption(2020).setOnChange(function(t){i.getInstance().set(i.endYear,t),this.startSearching()}.bind(this))}renderRelativeAbsolute(){let t=this.row.append("div").classed("col-2",!0);this.valueRadioGroup=new h(t),this.valueRadioGroup.setOptions([new g("relative","Relative"),new g("absolute","Absolute")]),this.valueRadioGroup.onChange=function(t){this.diachronicChart.valueType=t,this.diachronicChart.update(),this.valueType=t,i.getInstance().set(i.valueType,t),this.startSearching()}.bind(this)}renderFooterRow(){this.footer=this.row.append("div").classed("col-12 button-group margin-top text-end",!0)}renderPresentInnovationListPopupButton(){this.presentInnovationListPopupButton=new s(this.footer),this.presentInnovationListPopupButton.element.classed("button-down",!0),this.presentInnovationListPopupButton.setText(l.translate("Innovation List")),this.presentInnovationListPopupButton.onClick=function(t){if(!t||!t.target)return;let e=Z.default,a=new R(e.element);a.searchCard=this,a.showUnder(t.target,"center")}.bind(this)}renderSearchButton(){this.searchButton=new s(this.footer),this.searchButton.element.classed("button round-button",!0),this.searchButton.setText(l.translate("Search")),this.searchButton.onClick=function(){this.startSearching()}.bind(this)}getSearchText(){return this.searchField.getText()}startSearching(){}createFooter(){}get searchText(){return this.searchField.getText()}get sensitivity(){return this.sensitivityDropdown.value}get firstYear(){return this.yearStartDropdown.value}get lastYear(){return this.yearEndDropdown.value}}class T{constructor(t){this.type=t.type,this.features=[];for(let e=0;e<t.features.length;e++){let a=t.features[e],s=new P(a);this.features.push(s)}}getCenter(){let t=this.extractAllCoordinates();console.log("allCoordinates.length: "+t.length);let e=0,a=0;return t.forEach((function(t){e+=t[1],a+=t[0]})),[e/t.length,a/t.length]}extractGeometryCollection(){let t=[];if("Feature"===this.type)t.push(this.geometry);else if("FeatureCollection"===this.type)this.features.forEach((e=>t.push(e.geometry)));else{if("GeometryCollection"!==this.type)throw new Error("The geoJSON is not valid.");this.geometries.forEach((e=>t.push(e)))}return t}extractAllCoordinates(){let t=this.extractGeometryCollection(),e=[];return t.forEach((t=>{let a=t.coordinates,s=t.type;if("Point"===s)console.log("Point: "+a.length),e.push(a);else if("MultiPoint"===s)console.log("MultiPoint: "+a.length),a.forEach((t=>e.push(t)));else if("LineString"===s)console.log("LineString: "+a.length),a.forEach((t=>e.push(t)));else if("Polygon"===s)a.forEach((function(t){t.forEach((function(t){e.push(t)}))}));else if("MultiLineString"===s)a.forEach((function(t){t.forEach((function(t){t.forEach((function(t){e.push(t)}))}))}));else{if("MultiPolygon"!==s)throw new Error("The geoJSON is not valid.");a.forEach((function(t){t.forEach((function(t){t.forEach((function(t){e.push(t)}))}))}))}})),e}}class P{constructor(t){this.type=t.type,this.properties=t.properties,this.geometry=new M(t.geometry)}}class M{constructor(t){this.type=t.type,this.coordinates=t.coordinates}}function F(t){let e=[];for(let a=0;a<t.length;a++){let s=t[a];s.data.forEach((t=>{t.dataset=s.dlabel,t.stack=s.stack,e.push(t)}))}return e}function O(t){let e=[];for(let a=0;a<t.length;a++){let s=t[a],i=e.find((function(t){return t.dlabel===s.dlabel}));i?i.value+=s.value:e.push({dlabel:s.dlabel,stack:s.stack,value:s.value})}return e}class E extends a{constructor(t){super(t),this.element=t.append("div").attr("id",this.selector),this.initialize(),this.initializeProjection(),this.initializePath(),this.renderSVG(),this.renderMapBackground(),this.renderTooltipContainer(),this.renderLegend()}initialize(){this.width=1e3,this.height=1e3,this.tintColor="blue",this.backgroundColor="gray",this.backgroundOpacity=.2,this.isDrawsBackground=!0,this.isZoomable=!0,this.isShowLabels=!0,this.datasets=[],this.geoJSON=null,this.departmentsData=[],this.excludedFeatureCodes=["2A","2B"]}initializeProjection(){this.projection=d3.geoMercator()}initializePath(){this.path=d3.geoPath().projection(this.projection)}renderSVG(){this.svg=d3.select(`#${this.selector}`).append("svg").attr("id","map").classed("map",!0).attr("viewBox",`0 0 ${this.width} ${this.height}`)}renderMapBackground(){this.background=this.svg.append("rect").attr("width",this.width).attr("height",this.height).attr("fill",this.backgroundColor).attr("fill-opacity",function(){return this.isDrawsBackground?this.backgroundOpacity:0}.bind(this))}renderTooltipContainer(){let t=this.tintColor;this.tooltip=this.element.append("div").attr("class","map-tooltip").attr("rx",5).attr("ry",5).style("position","absolute").style("color","black").style("border",(function(){return`solid 1px ${t}`})).style("opacity",0),this.bounds=this.svg.append("rect").attr("class","bounds").style("position","absolute").style("pointer-events","none").style("fill-opacity",0).style("stroke","red").style("stroke-width","0.7px").style("stroke-dasharray","1,1")}renderLegend(){this.legend=this.svg.append("svg").attr("class","legend").attr("fill","red").attr("width",this.width).attr("height",200).attr("x",0).attr("y",0)}renderGeoJson(){let t=this.geoJSON,e=this.projection;t.features.forEach(function(t){t.center=d3.geoCentroid(t);let e=t.properties.code;this.departmentsData&&this.departmentsData.length&&(t.departmentsData=this.departmentsData.find((t=>+t.departmentNumber==+e)))}.bind(this)),d3.max(this.departmentsData,(t=>t.value));let a=this.tooltip,s=this.bounds;String(this.tooltip.style("width")||210).replace("px","");let i=this.tintColor,r=this;this.svg.selectAll("path").data(t.features).enter().append("path").attr("d",this.path).attr("id",(t=>t.properties.code)).attr("fill","white").attr("fill-opacity",.5).attr("stroke","black").attr("stroke-width","0.7").attr("stroke-dasharray",function(t){return t.departmentsData?"0":"1,4"}.bind(this)).attr("cursor","pointer").on("click",function(t,e){}.bind(this)).on("mouseenter",(function(t,n){d3.select(this).attr("stroke",(()=>i)).attr("stroke-width","2").attr("stroke-dasharray","0");let o=n.properties;if(!o)return;let l=o.code,h=Object.keys(o).map((function(t){return`${t.capitalize()}: ${o[t]}`})),d=F(r.datasets).filter((t=>+t.dlabel==+l));if(d)for(let t=0;t<d.length;t++){let e=d[t];h.push(e.datasetName+": "+e.value)}a.html(h.join("<br>"));let c=Number(a.style("width").replace("px","")||200),p=Number(a.style("height").replace("px",""));c+=20,p+=20;let u=d3.geoBounds(n),g=e(u[0]),m=e(u[1]),b=m[0]-g[0],C=g[1]-m[1],w=r.getElementEffectiveSize(),f=w[0]/r.width,y=w[1]/r.height,v=r.getElementPosition(),x=0;g[1]*y>w[1]/2?(x=m[1],x*=f,x-=p,x-=5):(x=g[1],x*=f,x+=5),x+=v[1];let k=g[0];k+=b/2,k*=f,k-=Number(c)/2,k+=v[0],a.style("opacity",1).style("left",k+"px").style("top",x+"px"),s.style("opacity",1).style("width",b+"px").style("height",C+"px").style("x",g[0]).style("y",m[1])})).on("mouseout",(function(t,e){d3.select(this).attr("stroke","black").attr("stroke-width","0.7").attr("stroke-dasharray",(function(t){return t.departmentsData?"0":"1,4"})),a.style("opacity",0),s.style("opacity",0)}))}renderDatasets(){if(!this.geoJSON)return;if(!this.datasets)return;let t=this.getStackNames(),e=O(F(this.datasets));w(0,1)[0],this.svg.selectAll("path").attr("fill","white").attr("fill-opacity",".5");for(let a=0;a<t.length;a++){let s=t[a],i=e.filter((t=>t.stack===s)),r=d3.max(i,(t=>t.value)),n=w(a,1)[0];for(let t=0;t<i.length;t++){let e=i[t],a=+e.dlabel;this.svg.selectAll("path").filter((t=>+t.properties.code===a)).attr("fill",n.rgbString()).attr("fill-opacity",e.value/r)}}}renderDatasetLabels(){if(!this.geoJSON)return;if(!this.datasets)return;let t=this.geoJSON,e=O(F(this.datasets));this.svg.selectAll(".map-label").remove(),this.svg.selectAll("text").data(t.features).enter().append("text").attr("class","map-label").attr("text-anchor","middle").attr("fill",this.tintColor).attr("font-size",12).attr("opacity",function(){return this.isShowLabels?1:0}.bind(this)).text((function(t){let a=+t.properties.code,s=e.find((t=>+t.dlabel===a));return s?s.value:""})).attr("x",function(t){return this.projection(t.center)[0]}.bind(this)).attr("y",function(t){return this.projection(t.center)[1]}.bind(this))}renderDatasetsLegend(){if(!this.datasets)return;let t=this.getStackNames(),e=function(t){let e=[];for(let a=0;a<t.length;a++){let s=t[a],i=e.find((function(t){return t.stack===s.stack&&t.dlabel===s.dlabel}));i?i.value+=s.value:e.push({dlabel:s.dlabel,stack:s.stack,value:s.value})}return e}(F(this.datasets));this.legend.raise(),this.legend.selectAll("rect").remove(),this.legend.selectAll("text").remove();for(let a=0;a<t.length;a++){let s=t[a],i=e.filter((t=>t.stack===s)),r=d3.max(i,(t=>t.value)),n=80*a,o=w(a,1)[0],l=4,h=[0,1,2,3,4];this.legend.append("text").attr("x",n+20).attr("y","14").style("fill",o.rgbString()).text(s),this.legend.append("g").selectAll("rect").data(h).enter().append("rect").style("fill",o.rgbString()).attr("x","20").attr("y","20").attr("width",18).attr("height",18).attr("transform",(function(t,e){return"translate("+n+","+20*e+")"})).style("stroke","black").style("stroke-width",1).style("fill-opacity",((t,e)=>e/l)),this.legend.append("g").selectAll("text").data(h).enter().append("text").style("fill",o.rgbString()).attr("x","40").attr("y","35").attr("width",18).attr("height",18).attr("transform",(function(t,e){return"translate("+n+","+20*e+")"})).style("stroke","black").style("stroke-width",1).style("fill-opacity",((t,e)=>e/l)).text((function(t,e){return e/l*r}))}}zoomTo(t){this.projection.fitSize([this.width,this.height],t)}getStackNames(){if(!this.datasets)return[];let t=this.datasets.map((t=>String(t.stack)));return Array.from(new Set(t))}update(){this.geoJSONDidChange(),this.datasetsDidChange()}loadGeoJSON(t){d3.json(t).then(function(t){this.setGeoJSON(new T(t))}.bind(this)).catch(function(t){console.log(t)}.bind(this))}setGeoJSON(t){this.geoJSON=t,this.geoJSONDidChange(),this.tooltip.raise()}setDatasets(t){this.datasets=t,this.datasetsDidChange(),this.tooltip.raise(),this.bounds.raise()}geoJSONDidChange(){this.geoJSON&&(this.removeExcludedFeatures(),this.zoomTo(this.geoJSON),this.renderGeoJson(),this.renderDatasets())}datasetsDidChange(){this.datasets&&(this.renderDatasets(),this.renderDatasetLabels(),this.renderDatasetsLegend())}getElementEffectiveSize(){let t=this.element.style("width").replace("px",""),e=this.element.style("height").replace("px","");return[Number(t),Number(e)]}getElementPosition(){let t=document.getElementById(this.selector).getBoundingClientRect();return[t.x+window.scrollX,t.y+window.scrollY]}removeExcludedFeatures(){if(!this.geoJSON)return;let t=this.excludedFeatureCodes;for(let e=0;e<t.length;e++){let a=t[e],s=this.geoJSON.features.find((t=>t.properties.code===a));if(!s)return;let i=this.geoJSON.features.indexOf(s);if(i<0)return;this.geoJSON.features.splice(i,1)}}}class G extends a{constructor(t){super(t),this.element=this.parent.append("div").attr("id",this.selector).classed("range-container",!0),this.renderMinLabel(),this.render(),this.renderMaxLabel(),this.renderValueLabel()}renderMinLabel(){this.minLabel=this.element.append("label").attr("id",this.selector+"-min-label")}render(){this.range=this.element.append("input").attr("type","range").attr("name","mySlider").attr("min","0").attr("max","100").on("input",function(t){t.target&&!t.target.value&&this.valueLabel.text(t.target.value)}.bind(this))}renderMaxLabel(){this.maxLabel=this.element.append("label").attr("id",this.selector+"-max-label")}renderValueLabel(){this.valueLabel=this.element.append("label").classed("range-value-label",!0)}get value(){return d3.select(this.range).attr("value")}set value(t){this.range.attr("value",t),this.valueLabel.text(t)}set minimum(t){this.range.attr("min",t),this.minLabel.text(t)}set maximum(t){this.range.attr("max",t),this.maxLabel.text(t)}}class V extends c{render(){this.card.headerRow.append("h3").text(l.translate("Settings")),this.row=this.card.body.append("div").classed("row",!0),this.renderShowLabelsCheckbox()}renderShowLabelsCheckbox(){let t=this.row.append("div").classed("col-12 margin-top",!0);this.showLabelsCheckbox=new m(t),this.showLabelsCheckbox.setText(l.translate("Labels")),this.showLabelsCheckbox.onClick=function(t){this.mapChart.isShowLabels=t,this.mapChart.update(),i.getInstance().setWithoutDeleting("map-show-labels",t)}.bind(this)}preferredSize(){return{width:240,height:600}}willShow(){super.willShow(),this.loadValues()}loadValues(){this.showLabelsCheckbox.setChecked(this.mapChart.isShowLabels),console.log("this.mapChart.showLabels: "+this.mapChart.isShowLabels)}}class N extends d{constructor(t){super(t),this.renderMenuItems(),this.renderMapChart()}renderSlider(){this.slider=new G(this.headerCenterComponent),this.slider.minimum=1995,this.slider.maximum=2020,this.slider.value=2e3}renderMenuItems(){this.screenshotButton=new s(this.headerRightComponent),this.screenshotButton.setText("Screenshot"),this.screenshotButton.element.classed("simple-button",!0),this.screenshotButton.setFontAwesomeImage("camera"),this.screenshotButton.onClick=this.screenshotButtonAction.bind(this),this.moreButton=new s(this.headerRightComponent),this.moreButton.setText("More"),this.moreButton.element.classed("simple-button",!0),this.moreButton.setFontAwesomeImage("ellipsis-h"),this.moreButton.onClick=this.presentSettingsPopupAction.bind(this)}renderMapChart(){this.mapChart=new E(this.body),this.mapChart.loadGeoJSON("/assets/Departements-Simple.geojson")}screenshotButtonAction(){x("#"+this.mapChart.selector,"my_image.jpg")}presentSettingsPopupAction(){let t=window.frcvApp,e=document.getElementById(this.moreButton.selector),a=new V(t.element);a.mapChart=this.mapChart,a.showUnder(e,"right")}}class W extends c{render(){super.render(),this.renderHeadline(),this.renderRow(),this.renderTrackContentContainer()}renderHeadline(){this.card.headerRow.append("h3").text(l.translate("Track"))}renderRow(){this.row=this.card.body.append("div").classed("row",!0)}renderTrackContentContainer(){this.lyricsContainer=this.row.append("div").classed("col-12",!0).append("p")}update(){if(!this.track)return;let t=this.searchWord,e=String(this.track.content).split("\n"),a="";for(let s=0;s<e.length;s++){let i=e[s].split(" ");for(let e=0;e<i.length;e++){let s=i[e];s.toLowerCase()===t.toLowerCase()||s.toLowerCase()===`${t},`.toLowerCase()?a+=`<b class="important">${s}</b>`:a+=s,a+=" "}a+="<br>"}this.lyricsContainer.html(a)}preferredSize(){return{width:800,height:600}}}class z extends d{constructor(t){super(t)}update(){this.body.html(""),this.datasets&&(this.divs=this.body.selectAll("div").data(this.datasets).enter().append("div").html((function(t,e){let a=[];return 0!==e&&a.push("<br>"),a.push('<b class="larger">'),a.push(`${t.label}`),a.push(` (${t.data.length} Tracks)`),a.push("</b>"),a.join("")})).selectAll("div").data((function(t){return t.data.forEach((e=>e.dataset=t.label)),t.data.sort((function(t,e){return d3.descending(t.releaseYear,e.releaseYear)}))})).enter().append("div").style("cursor","pointer").html((function(t){let e=[];return e.push(`<span class="primary">${t.title}</span>`),e.push(`<span class="secondary">(by ${t.artist}, ${t.releaseYear})</span>`),`<li>${e.join(" ")}</li>`})).on("click",(function(t,e){let a=window.frcvApp.element,s=new W(a);console.log(e),s.searchWord=e.dataset,s.track=e,s.update(),s.showBigModal()})))}}class U extends Array{}class H extends u{constructor(t){super(t,l.translate("Search")),t.makeContainerFull(),this.renderSettingsButton(),this.renderSearchInputCard(),this.renderDiachronicChart(),this.renderMapChart(),this.renderWordAboutCard(),this.loadCorpusIfNeeded(),this.applyURLParameters()}renderSettingsButton(){this.settingsButton=new s(this.rightHeaderContainer),this.settingsButton.setText(l.translate("Settings")),this.settingsButton.element.classed("simple-button button-down",!0);let t=this;this.settingsButton.onClick=function(e){if(!e||!e.target)return;let a=new b(t.application.element);a.searchPage=t,a.showUnder(e.target,"right")}}renderSearchInputCard(){this.searchCardContainer=this.addContainer(this.row,"col-12"),this.searchCard=new I(this.searchCardContainer);let t=this;this.searchCard.startSearching=function(){t.startSearching()}}renderDiachronicChart(){this.diachronicChartCardContainer=this.addContainer(this.row,"col-12 col-lg-6"),this.diachronicChartCard=new k(this.diachronicChartCardContainer,null),this.diachronicChartCard.titleLabel.text(l.translate("Chart")),this.diachronicChart=this.diachronicChartCard.chart,this.searchCard.diachronicChart=this.diachronicChart,this.diachronicChart.margin={top:40,left:40,bottom:80,right:40},this.diachronicChartCard.footer.style("display","none")}renderMapChart(){this.mapCardContainer=this.addContainer(this.row,"col-12 col-lg-6"),this.mapChartCard=new N(this.mapCardContainer),this.mapChartCard.titleLabel.text(l.translate("Map"))}renderWordAboutCard(){this.wordAboutCardContainer=this.addContainer(this.row,"col-12 col-lg-6"),this.wordAboutCard=new z(this.diachronicChartCardContainer),this.wordAboutCard.titleLabel.text(l.translate("Word About"))}willLoadCorpus(){super.willLoadCorpus(),this.loadingView=this.addLoadingView(this.row),this.diachronicChartCardContainer.style("display","none"),this.mapCardContainer.style("display","none")}didLoadCorpus(){super.didLoadCorpus(),this.loadingView.remove(),this.diachronicChartCardContainer.style("display","block"),this.mapCardContainer.style("display","block"),this.searchCard.getSearchText()&&this.startSearching()}useFullWidthMode(){this.diachronicChartCardContainer.classed("col-lg-12",!0).classed("col-lg-6",!1),this.mapCardContainer.classed("col-lg-12",!0).classed("col-lg-6",!1),this.wordAboutCardContainer.classed("col-lg-12",!0).classed("col-lg-6",!1)}useHalfWidthMode(){this.diachronicChartCardContainer.classed("col-lg-12",!1).classed("col-lg-6",!0),this.mapCardContainer.classed("col-lg-12",!1).classed("col-lg-6",!0),this.wordAboutCardContainer.classed("col-lg-12",!1).classed("col-lg-6",!0)}setViewMode(t,e=!1){switch(this.viewMode=t,t){case"full":this.useFullWidthMode();break;case"half":this.useHalfWidthMode()}e&&localStorage.setItem(H.viewModeKey,t)}applyURLParameters(){let t=i.getInstance(),e=t.getString(i.query),a=t.getString(i.searchSensitivity,"case-insensitive"),s=t.getString(i.startYear,"2000"),r=t.getString(i.endYear,"2020"),n=t.getString(i.valueType,"relative");this.searchCard.searchField.setText(e),this.searchCard.sensitivityDropdown.setSelectedOption(a),this.searchCard.yearStartDropdown.value=s,this.searchCard.yearEndDropdown.value=r,this.searchCard.valueType=n,this.searchCard.valueRadioGroup.setSelectedOption(n);let o=i.getInstance().getString(i.searchViewMode),l=localStorage.getItem(H.viewModeKey);o?this.setViewMode(o):l?this.setViewMode(l):this.setViewMode("half"),t.getBoolean("show-chart",!0)?this.showChart():this.hideChart(),t.getBoolean("show-map",!0)?this.showMap():this.hideMap()}showChart(){this.diachronicChartCard.element.style("display","block")}hideChart(){this.diachronicChartCard.element.style("display","none")}showMap(){this.mapChartCard.element.style("display","block")}hideMap(){this.mapChartCard.element.style("display","none")}showWordAbout(){this.wordAboutCard.element.style("display","block")}hideWordAbout(){this.wordAboutCard.element.style("display","none")}startSearching(){if(!this.application.isCorpusLoaded())return;let t=this.searchCard.getSearchText(),e=this.searchCard.searchField;return void 0===t?console.log("search text undefined"):0===t.trim().length?console.log("search text too short"):(L.getInstance().append(t),e.updateRecentSearches(),void this.searchFor(t))}searchFor(t){let e=t.split(";").map((t=>t.trim()));e=e.map((t=>t.split(",").map((t=>t.trim())).join(","))),e=e.map((t=>t.trim()));let a=e.join(";"),s=[],r=[],n=new U;for(let t=0;t<e.length;t++){let a=e[t].split(",").map((t=>t.trim())),i=a.join(", ");for(let t=0;t<a.length;t++){let e=a[t],o=this.datasetFor(e),l=o.chartData,h=o.mapData,d=o.tracks,c={label:e,stack:i,data:l};"relative"===this.searchCard.valueType&&l.forEach((t=>t.value=t.value/t.yearTotal));let p={label:e,stack:i,data:h};s.push(c),r.push(p),n.push({label:e,stack:i,data:d})}}this.diachronicChart.datasets=s,this.diachronicChart.update(),this.mapChartCard.mapChart.datasets=r,this.mapChartCard.mapChart.update(),this.wordAboutCard.datasets=n,this.wordAboutCard.update(),i.getInstance().set(i.query,a)}datasetFor(t){let e=this.searchCard.sensitivity,a=this.searchCard.firstYear,s=this.searchCard.lastYear,i=this.application.corpus,r=i.tracksForWord(t,e);r=r.filter((function(t){return t.releaseYear>=a&&t.releaseYear<=s}));let n=i.getMapDataForTracks(r);return n.forEach((e=>e.datasetName=t)),{mapData:n,chartData:i.getChartDataForTracks(r,a,s,e),searchText:t,tracks:r}}applyMapData(t){let e="rgb("+255*Math.random()+", "+255*Math.random()+","+255*Math.random()+")";for(let a=0;a<t.length;a++){const s=t[a],i=s.departementNumber,r=s.value;if(0===r)continue;const n=this.application.getDepartementForNumber(i);this.mapChart.drawDepartement(n,e,""+r)}}}H.viewModeKey="de.beuth.frc-visualization.SearchPageViewMode";class $ extends u{constructor(t){super(t,l.translate("Corpus Metadata")),this.createLeftPanel(),this.createCard(),this.loadCorpusIfNeeded()}willLoadCorpus(){super.willLoadCorpus(),this.loadingView=this.addLoadingView(this.cardBody)}didLoadCorpus(){super.didLoadCorpus(),this.loadingView.remove(),this.update()}createLeftPanel(){this.leftPanel=this.addContainer(this.row,"col-lg-3"),this.titleLabel=this.leftPanel.append("h1").text(this.title)}createCard(){this.wrapper=this.addContainer(this.row,"col-lg-6 col-12"),this.card=this.addContainer(this.wrapper,"card card-corpus-metadata"),this.cardBody=this.addContainer(this.card,"card-body"),this.cardBodyRow=this.addRow(this.cardBody)}update(){this.clearContent();let t=this.application.corpus;this.currentGroup=this.createGroup(),this.createLine("# Artists",t.artists.length),this.createLine("# Female Artists",t.femaleArtists().length),this.createLine("# Male Artists",t.maleArtists().length),this.createLine("# Group Artists",t.groupArtists().length),this.currentGroup=this.createGroup(),this.createLine("# Albums",t.allAlbums().length),this.currentGroup=this.createGroup(),this.createLine("# Tracks w/o Album",t.allTracksWithoutAlbum().length),this.createLine("# Tracks",t.allTracks().length),this.currentGroup=this.createGroup(),this.createLine("# Words",t.allWords().length)}createGroup(){return this.addContainer(this.cardBodyRow,"group")}createLine(t,e){let a=this.currentGroup.append("div").classed("row text-vertical-center",!0);var s;a.append("div").classed("col-6 text-end label",!0).text((s=t).endsWith(":")?s:s+":"),a.append("div").classed("col-6",!0).append("samp").text(e)}clearContent(){this.cardBody.selectAll("div").remove(),this.cardBodyRow=this.addRow(this.cardBody)}}class Y extends a{constructor(t){super(t),this.renderBar()}renderBar(){this.barContainerSelector=e(),this.barContainer=this.parent.append("div").attr("id",this.barContainerSelector).attr("class","progress-bar-container"),this.element=this.barContainer,this.barSelector=e(),this.bar=this.barContainer.append("div").attr("id",this.barSelector).attr("class","progress-bar").html("&nbsp;")}set value(t){let e=Number(t),a=document.getElementById(this.barContainerSelector).getBoundingClientRect().width,s=Number(a)*e;document.getElementById(this.barSelector).setAttribute("style","width:"+s+"px")}get value(){let t=document.getElementById(this.barContainerSelector).style.width;document.getElementById(this.barSelector).style.width,console.log("totalWidth: "+t)}}class j extends u{constructor(t){if(super(t,"Main"),!t)throw"No application given.";this.application=t,this.element=t.element,this.renderLeftTitleComponent(),this.renderMenuCard(),this.renderMenuItems(),this.renderProgressBar(),this.hideBackButton(),this.updateFooterURL(),this.updateFooterDebugInfo(),this.loadData()}renderLeftTitleComponent(){this.titleContainer=this.row.append("div").classed("col-lg-3",!0);let t=this.application.delegate.name;this.titleLabel=this.titleContainer.append("h1").text(t),this.titleInfoBox=this.titleContainer.append("div").classed("info-box",!0)}renderMenuCard(){this.menuCardContainer=this.row.append("div").classed("col-6",!0),this.menuCard=this.menuCardContainer.append("div").classed("card card-inset menu",!0)}renderMenuItems(){let t=this.application,e=[["search",l.translate("Search")],["diachronic-data",l.translate("Diachronic Data")],["diatopic-data",l.translate("Diatopic Data")],["corpus-data",l.translate("Corpus Data")]];for(let a=0;a<e.length;a++){let s=e[a],i=s[0],r=s[1];this.addMenuButton(r,(function(){t.showPage(i,!0)}))}}addMenuButton(t,e){let a=this.menuCard.append("a").text(t).on("click",(function(){e&&e()}));return this.menuCard.append("br"),a}renderProgressBar(){this.progressBar=new Y(this.menuCardContainer),this.progressBar.value=0}loadData(){let t=this.application.delegate;if(t.rawJSON)return;let e=this.progressBar;t.loadData((function(t,a){e.value=t}),(function(){e.hide()}))}}class J extends u{constructor(t){super(t,l.translate("Diachronic About")),this.contentType="tracks",this.buildSubpage(),this.renderDiachronicChart(),this.renderContentRadioGroup(),this.applyURLParameters(),this.loadCorpusIfNeeded()}renderDiachronicChart(){this.chartWrapper=this.addContainer(this.row,"col-12").append("div"),this.chartCard=new k(this.chartWrapper,"Chart"),this.chart=this.chartCard.chart,this.chartCard.chart.margin={top:60,left:50,bottom:70,right:50}}renderContentRadioGroup(){this.radioGroup=new h(this.chartCard.headerCenterComponent),this.radioGroup.setOptions([["tracks",l.translate("Tracks")],["words",l.translate("Words")],["words-relative",l.translate("Words (Relative)")],["types",l.translate("Types")],["types-relative",l.translate("Types (Relative)")]]),this.radioGroup.onChange=function(t){this.contentType=t,this.update()}.bind(this)}willLoadCorpus(){super.willLoadCorpus(),this.showLoadingView()}didLoadCorpus(){super.didLoadCorpus(),this.hideLoadingView(),this.update()}applyURLParameters(){this.contentType=i.getInstance().getString(i.contentType,"tracks"),this.radioGroup.setSelectedOption(this.contentType)}update(){let t=this.application.corpus;t&&this.setCorpus(t)}contentTypeDidChange(){}setCorpus(t){let e;switch(this.contentType){case"tracks":e=t.getLyricsPerYear();break;case"words":e=t.getWordsPerYear();break;case"words-relative":e=t.getWordsPerYearRelative();break;case"types":e=t.getTypesPerYear();break;case"types-relative":e=t.getTypesPerYearRelative();break;case"non-standard":e=t.getTotalNonStandardPerYearCount();break;default:e=[]}i.getInstance().set(i.contentType,this.contentType);let a=this.contentType.capitalize(),s={label:a,stack:a,data:[]},r=d3.min(Object.keys(e)),n=d3.max(Object.keys(e));for(let t=r;t<=n;t++)s.data.push({year:t,value:e[t]||0,yearTotal:e[t]||0});this.chart.datasets=[s],this.chart.update()}}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};class _ extends u{constructor(t){super(t,"Artists Metadata"),this.buildSubpage(),this.createCard(),this.createContentTypeRadioGroup(),this.valueGettingFunction=this.numberOfTypes,this.initialize(),this.renderSVG(),this.renderTooltip(),this.loadCorpusIfNeeded()}initialize(){this.width=1e3,this.margin={top:20,right:70,bottom:50,left:180},this.graphWidth=this.width-this.margin.left-this.margin.right,this.lineHeight=18}renderSVG(){this.chartView=this.card.content,this.svg=this.chartView.append("svg"),this.graph=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")}renderTooltip(){this.tooltip=this.card.content.append("div").attr("class","tooltip map-tooltip").style("position","absolute").style("border","1px solid #69b3a2").style("display","none")}buildVisual(t){const e=this.margin,a=d3.max(t,(t=>t.value)),s=w(0,1)[0].rgbString();this.graphHeight=this.lineHeight*t.length,this.height=this.graphHeight+(e.top+e.bottom),this.graph.selectAll("g").remove(),this.graph.selectAll("text").remove(),this.graph.selectAll("rect").remove(),this.svg.attr("viewBox",`0 0 ${this.width} ${this.height}`);const i=d3.scaleLinear().domain([0,a]).range([0,this.graphWidth]),r=d3.scaleBand().range([0,this.graphHeight]).domain(t.map((t=>`${t.name} (${t.geniusId})`))).padding(.1);this.graph.append("g").attr("transform","translate(0,"+this.graphHeight+")").call(d3.axisBottom(i)).selectAll("text").attr("transform","translate(-10,0)rotate(-45)").style("text-anchor","end"),this.graph.append("g").call(d3.axisLeft(r));const n=this.graph.selectAll("chart-rect").data(t).enter().append("rect").classed("chart-rect",!0);n.attr("x",i(0)).attr("y",(t=>r(`${t.name} (${t.geniusId})`))).attr("width",(t=>i(t.value))).attr("height",r.bandwidth()).attr("fill",s).attr("rx","4").attr("ry",this.lineHeight/2),n.on("mousemove",function(t,a){this.tooltip.style("display","inline-block").html("Value: "+a.value+"<br>Artist: "+a.name);let s=this.tooltip.style("width").replace("px",""),n=document.getElementById("content").getBoundingClientRect(),o=this.chartView.style("width").replace("px","")/1e3;console.log("ratio: "+o);let l=i(a.value)/2;l+=n.x,l*=o,l+=e.left,l+=window.scrollX,l-=s/2;let h=r(`${a.name} (${a.geniusId})`);h+=e.top,h*=o,h+=n.y,h+=this.lineHeight,h+=window.scrollY,this.tooltip.style("left",l+"px").style("top",h+"px").style("position","absolute").style("border","1px solid #69b3a2").style("display","inline-block").html("Value: "+a.value+"<br>Artist: "+a.name)}.bind(this)).on("mouseout",function(t){this.tooltip.style("display","none")}.bind(this)),this.graph.selectAll(".text").data(t).enter().append("text").text((t=>t.value)).attr("x",(t=>i(t.value))).attr("y",(t=>r(`${t.name} (${t.geniusId})`))).attr("dy",this.lineHeight-6).attr("dx","6").attr("width",(t=>i(t.value))).attr("height",r.bandwidth()).attr("font-size",13).attr("fill","gray")}willLoadCorpus(){super.willLoadCorpus(),this.loadingView=this.addLoadingView(this.card.body)}didLoadCorpus(){super.didLoadCorpus(),this.update(),this.loadingView.remove()}createCard(){this.cardContainer=this.addContainer(this.row,"col-12"),this.card=new d(this.cardContainer)}createContentTypeRadioGroup(){this.card.headerCenterComponent.classed("text-center",!0).append("div").attr("id","radio-group-2"),this.radioGroup=new h(this.card.headerCenterComponent),this.radioGroup.setOptions([["types","Types"],["words","Words"],["tracks","Tracks"],["albums","Albums"]]),this.radioGroup.onChange=function(t){this.chartTypeAction(t)}.bind(this)}chartTypeAction(t){switch(console.log("value: "+t),t){case"types":this.valueGettingFunction=this.numberOfTypes;break;case"words":this.valueGettingFunction=this.numberOfWords;break;case"tracks":this.valueGettingFunction=this.numberOfTracks;break;case"albums":this.valueGettingFunction=this.numberOfAlbums;break;default:console.log("unknown chart type: "+t)}this.update()}numberOfTypes(t){return new Set(t.allWords()).size}numberOfWords(t){return t.allWords().length}numberOfTracks(t){return t.allTracks().length}numberOfAlbums(t){return t.albums.length}update(){let t=this.application.corpus;if(!t)return;d3.hierarchy(t.artists);const e=t.artists.filter((t=>t.allTracks().length>0)).reverse();let a=[];for(let t=0;t<e.length;t++){let s=e[t],i=s.name,r=this.valueGettingFunction(s);a.push({name:i,geniusId:s.geniusId,departement:s.departement,departementNo:s.departementNo,value:Number(r)})}a=d3.sort(a,(function(t,e){return e.value-t.value}));const s=a.length;a=a.filter((t=>t.value>0));const i=a.length;console.log("countAll: "+s),console.log("countFiltered: "+i),this.buildVisual(a)}buildHistogram(t){}}class K extends u{constructor(t){super(t,l.translate("Location Data")),this.buildSubpage(),this.applyURLParameters(),this.loadGeoJSONFromDelegate(),this.didLoadGeoJSONFromDelegate()}renderBody(){super.renderBody(),this.mapChartContainer=this.row.append("div").classed("col-12",!0),this.mapChartCard=new N(this.mapChartContainer),this.mapChartCard.titleLabel.text(l.translate("Map")),this.mapChartCard.mapChart.isDrawsBackground=!1,this.mapChartCard.mapChart.isShowLabels=!0,this.mapChartCard.mapChart.isZoomable=!1}applyURLParameters(){let t=i.getInstance().getBoolean("map-show-labels",!0);this.mapChartCard.mapChart.isShowLabels=t,this.mapChartCard.mapChart.update()}loadGeoJSONFromDelegate(){let t=this.application.delegate.geoJSON;this.mapChartCard.mapChart.loadGeoJSON(t)}didLoadGeoJSONFromDelegate(){this.mapChartCard.mapChart,this.application.corpus}}class q{constructor(){}}class X extends q{constructor(){super(),this.name="Lotivis"}}class Z{constructor(t,e){if(!t)throw"No selector specified.";e||(e=new X),this.selector=t,this.delegate=e,this.willInitialize(),this.initialize(),this.didInitialize()}willInitialize(){}initialize(){this.element=d3.select(`#${this.selector}`).classed("container",!0),window.lotivisApplication=this;let t=i.getInstance().getString(i.language,l.English);l.setLanguage(t)}didInitialize(){this.loadPage()}clearContainer(){document.getElementById(this.selector).innerHTML=""}loadPage(){let t=i.getInstance().getString(i.page,"main");this.showPage(t,!1)}showPage(t,e=!1){switch(this.clearContainer(),e&&(i.getInstance().clear(),i.getInstance().set(i.page,t),i.getInstance().set(i.language,l.language)),this.currentPageSelector=t,t){case"search":this.currentPage=new H(this);break;case"about":this.currentPage=new AboutPage(this);break;case"corpus-data":this.currentPage=new $(this);break;case"artists-data":this.currentPage=new _(this);break;case"diachronic-data":this.currentPage=new J(this);break;case"diatopic-data":this.currentPage=new K(this);break;default:this.currentPage=new j(this),this.currentPageSelector="main"}console.log(this.currentPage)}reloadPage(){this.showPage(this.currentPageSelector)}makeFluit(){this.element.classed("container-fluit",!0),this.element.classed("container",!1)}makeUnfluit(){this.element.classed("container-fluit",!1),this.element.classed("container",!0)}isCorpusLoaded(){return void 0!==this.corpus}loadCorpus(t){this.isLoading=!0;d3.json("../../corpus/original").then((function(t){}))}fetchDepartements(t){let e=this;this.isFetchingDepartements=!0,fetch("../../departements").then((t=>t.json())).then((function(a){e.departements=a,e.corpus.departements=a,e.isFetchingDepartements=!1,t&&t()}))}getDepartementForNumber(t){for(let e=0;e<this.departements.length;e++){const a=this.departements[e];if(t===a.deptCode)return a}return null}makeContainerNormal(){this.element.classed("container-full",!1),this.element.classed("container",!0)}makeContainerFull(){this.element.classed("container",!1),this.element.classed("container-full",!0)}}Z.Pages={},t.DataDelegate=q,t.Application=Z,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=lotivis.min.js.map
