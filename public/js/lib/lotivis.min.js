/**
 * Minified by jsDelivr using Terser v5.3.5.
 * Original file: /npm/lotivis@1.0.89/dist/lotivis.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
/*!
 * lotivis.js v1.0.89
 * https://github.com/lukasdanckwerth/lotivis#readme
 * (c) 2021 lotivis.js Lukas Danckwerth
 * Released under the MIT License
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).lotivis={})}(this,(function(t){"use strict";class e{constructor(t,e,s){if(!t&&0!==t||!e&&0!==e||!s&&0!==s)if("object"==typeof t)this.initialize(t.r,t.g,t.b);else if(t);else{if(!t)throw new Error("Invalid argument: "+t);this.initialize(t,t,t)}else this.initialize(t,e,s)}initialize(t,e,s){this.r=Math.round(t),this.g=Math.round(e),this.b=Math.round(s)}rgbString(){return`rgb(${this.r},${this.g},${this.b})`}toString(){return this.rgbString()}colorAdding(t,s,a){return new e(this.r+t,this.g+s,this.b+a)}}var s,a;e.defaultTint=new e(0,122,255),e.organgeLow=new e(250,211,144),e.organgeHigh=new e(229,142,38),e.redLow=new e(248,194,145),e.redHigh=new e(183,21,64),e.blueLow=new e(106,137,204),e.blueHigh=new e(12,36,97),e.lightBlueLow=new e(130,204,221),e.lightBlueHight=new e(10,61,98),e.greenLow=new e(184,233,148),e.greenHight=new e(7,153,146),e.stackColors=[[e.blueHigh,e.blueLow],[e.redHigh,e.redLow],[e.greenHight,e.greenLow],[e.organgeHigh,e.organgeLow],[e.lightBlueHight,e.lightBlueLow]],e.colorGenerator=function(t){return d3.scaleLinear().domain([0,1/3*t,2/3*t,t]).range(["yellow","orange","red","purple"])},e.plotColor=function(t){return d3.scaleLinear().domain([0,.5*t,t]).range(["lightgreen","steelblue","purple"])},e.randomColor=function(){return"rgb("+255*Math.random()+", "+255*Math.random()+","+255*Math.random()+")"};try{s=require("d3")}catch(t){s=d3}function i(t){let e,s,a=0;for(e=0;e<t.length;e++)s=t.charCodeAt(e),a=(a<<5)-a+s,a|=0;return a}function r(t){return t.replaceAll(" ","-").replaceAll("/","-").replaceAll(".","-")}function n(t){return t&&t.label?i(t.label):0}e.colorsForStack=function(t,a=1){let i=e.stackColors[t%e.stackColors.length],r=s.scaleLinear().domain([0,a]).range([i[0],i[1]]),n=[];for(let t=0;t<a;t++){let s=r(t);n.push(new e(s))}return n},function(){let t=0;a=function(){return"lotivis-id-"+t++}}();class o extends Error{constructor(t){super(t),this.name=this.constructor.name}}class l extends o{constructor(t){super(`Can't find an element with ID '${t}'.`)}}class h extends o{}class c extends h{constructor(t,e){super(t+" "+JSON.stringify(e||{})),this.data=e}}class d extends h{}class u extends o{constructor(t){super(`Subclasses must override function '${t}'.`)}}t.LotivisError=o,t.DataValidateError=h,t.MissingPropertyError=c,t.InvalidFormatError=d,t.GeoJSONValidateError=class extends o{},t.LotivisUnimplementedMethodError=u;class p{constructor(t){if(!t)throw new o("No parent or selector specified.");Object.getPrototypeOf(t)===String.prototype?this.initializeFromSelector(t):Object.getPrototypeOf(t)===Object.prototype?this.initializeFromConfig(t):this.initializeFromParent(t),this.element=void 0}initializeFromSelector(t){if(this.selector=t,this.parent=d3.select("#"+t),this.parent.empty())throw new l(t)}initializeFromConfig(t){if(this.config=t,t.selector)this.initializeFromSelector(t.selector);else{let t=(e=this.constructor.name,e.replace(/([A-Z])/g,(function(t){return" "+t})).replace(/^./,(function(t){return t.toUpperCase()}))).toLowerCase().trim().replaceAll(" ","-");this.initializeFromSelector(t)}var e}initializeFromParent(t){this.selector=a(),this.parent=t}show(){if(this.element)return this.element.style("display",""),this}hide(){if(this.element)return this.element.style("display","none"),this}get isVisible(){return!!this.element&&"none"!==this.element.style("display")}getElementEffectiveSize(){if(!this.element)return[0,0];let t=this.element.style("width").replace("px",""),e=this.element.style("height").replace("px","");return[Number(t),Number(e)]}getElementPosition(){let t=document.getElementById(this.selector);if(!t)return[0,0];let e=t.getBoundingClientRect();return[e.x+window.scrollX,e.y+window.scrollY]}toString(){let t=[this.constructor.name];return this.selector&&t.push(`'${this.selector}'`),`[${t.join(" ")}]`}getClassname(){return this.constructor&&this.constructor.name?this.constructor.name:typeof this}}class f extends p{constructor(t,e="default"){switch(super(t),this.element=t.append("button").attr("id",this.selector).attr("class","lotivis-button").on("click",function(t){this.onClick&&this.onClick(t)}.bind(this)),e){case"round":this.element.classed("lotivis-button-round",!0)}}setText(t){this.element.text(t)}onClick(t){}}class g extends p{constructor(t){super(t),this.inputElements=[],this.element=this.parent.append("form"),this.element.classed("radio-group",!0)}addOption(t,e){let s=this.element.append("input").attr("type","radio").attr("name",this.selector).attr("value",t).attr("id",t);this.element.append("label").attr("for",t).text(e||t);let a=this;return s.on("click",(function(t){a.onClick(t)})),s}setOptions(t){this.removeOptions(),this.inputElements=[];for(let e=0;e<t.length;e++){let s=t[e][0]||t[e].id,a=t[e][1]||t[e].translatedTitle,i=this.addOption(s,a);0===e&&i.attr("checked","true"),this.inputElements.push(i)}return this}setSelectedOption(t){for(let e=0;e<this.inputElements.length;e++){let s=this.inputElements[e];s.attr("value")===t&&s.attr("checked","true")}return this}removeOptions(){return this.element.selectAll("input").remove(),this.element.selectAll("label").remove(),this.inputElements=[],this}onClick(t){let e=t.target;if(!e)return;let s=e.value;return this.onChange?(this.onChange(s),this):void 0}onChange(t){}}class m extends p{constructor(t){super(t),this.element=this.parent.append("div").attr("class","lotivis-data-card-status-tooltip").style("opacity",0).style("display","none"),this.row=this.element.append("div").attr("class","lotivis-row"),this.leftComponnt=this.row.append("div").attr("class","lotivis-col-6"),this.rightComponent=this.row.append("div").attr("class","lotivis-col-6"),this.hideButton=new f(this.rightComponent).setText("Hello")}show(){return super.show(),this.element.style("opacity",1),this}hide(){super.hide(),this.element.style("opacity",0)}setText(t){this.element.text(t)}setStatusMessage(t){let e=String(t||"").trim();this.element.text(e),e?this.show():this.hide()}}class b{constructor(t){this.title=t,this.id=r(t)}}const w={defaultMargin:60,tooltipOffset:7,barRadius:5,debugLog:!1,debug:!0,downloadFilePrefix:"lotivis",filenameSeparator:"_",unknown:"LOTIVIS_UNKNOWN"};let y=[];var v=function(t){y.includes(t)||(y.push(t),console.warn("[lotivis]  Warning only once: "+t))},C=()=>null;class x extends p{constructor(t,e){super(t),this.svgSelector=(this.selector||a())+"-svg",this.element=this.parent,this.element.attr("id",this.selector),this.config=e||{},this.updateSensible=!0,this.initialize(),this.config.datasets?this.setDatasets(this.config.datasets):this.update()}initialize(){return new u("initialize()")}update(t,e){C("reason: "+e),this.updateSensible&&(this.remove(),this.precalculate(),this.draw())}precalculate(){return new u("precalculate()")}remove(){return new u("remove()")}draw(){return new u("draw()")}makeUpdateInsensible(){this.updateSensible=!1}makeUpdateSensible(){this.updateSensible=!0}}function S(t){return JSON.parse(JSON.stringify(t))}function D(t){return Boolean(t||0===t)}function k(t){return t||(0===t?0:w.unknown)}function R(t){let e=[],s=S(t);for(let t=0;t<s.length;t++){let a=s[t],i=e.find((function(t){return t.dataset===a.dataset&&t.stack===a.stack&&t.label===a.label&&t.location===a.location&&t.date===a.date}));if(i)i.value+=a.value+0;else{let t={};D(a.label)&&(t.label=a.label),D(a.dataset)&&(t.dataset=a.dataset),D(a.stack)&&(t.stack=a.stack),D(a.location)&&(t.location=a.location),D(a.locationTotal)&&(t.locationTotal=a.locationTotal),D(a.date)&&(t.date=a.date),D(a.dateTotal)&&(t.dateTotal=a.dateTotal),D(a.locationName)&&(t.locationName=a.locationName),t.value=a.value||0,e.push(t)}}return e}function L(t){let e=[];for(let s=0;s<t.length;s++){let a=t[s],i=e.find((function(t){return t.stack===a.stack&&t.location===a.location&&t.date===a.date}));if(i)i.value+=a.value+0;else{let t={};D(a.label)&&(t.label=a.label),D(a.dataset)&&(t.dataset=a.dataset),D(a.stack)&&(t.stack=a.stack),D(a.location)&&(t.location=a.location),D(a.locationTotal)&&(t.locationTotal=a.locationTotal),D(a.date)&&(t.date=a.date),D(a.dateTotal)&&(t.dateTotal=a.dateTotal),D(a.locationName)&&(t.locationName=a.locationName),t.value=a.value||0,e.push(t)}}return e}function F(t){let e=[];for(let s=0;s<t.length;s++){let a=t[s],i=e.find((function(t){return t.dataset===a.dataset&&t.stack===a.stack&&t.label===a.label&&t.date===a.date}));if(i)i.value+=a.value+0;else{let t={};D(a.label)&&(t.label=a.label),D(a.dataset)&&(t.dataset=a.dataset),D(a.stack)&&(t.stack=a.stack),D(a.date)&&(t.date=a.date),D(a.dateTotal)&&(t.dateTotal=a.dateTotal),t.value=a.value||0,e.push(t)}}return e}function T(t){let e=[];for(let s=0;s<t.length;s++){let a=t[s],i=e.find((function(t){return t.dataset===a.dataset&&t.stack===a.stack&&t.label===a.label&&t.location===a.location}));if(i)i.value+=a.value;else{let t={};D(a.label)&&(t.label=a.label),D(a.dataset)&&(t.dataset=a.dataset),D(a.stack)&&(t.stack=a.stack),D(a.location)&&(t.location=a.location),D(a.locationTotal)&&(t.locationTotal=a.locationTotal),D(a.locationName)&&(t.locationName=a.locationName),t.value=a.value,e.push(t)}}return e}function A(t,e){return O(t.filter((t=>t.stack===e)))}function O(t){return t.map((t=>+(t.value||0))).reduce(((t,e)=>t+e),0)}const N=t=>t;class B{constructor(){let t={};function e(t,e,s,a){return t+e+s+a}this.getDataview=function(s,a,i,r){let n=e(s,a,i,r);return t[n]},this.setDataview=function(s,a,i,r,n){let o=e(a,i,r,n);t[o]=s,C("this.content: ",this.content)},this.invalidate=function(){t={}}}}class E{constructor(t,e){if(!Array.isArray(t))throw new d("Datasets are not an array.");this.initialize(e||{}),this.setDatasets(t)}initialize(t){this.config=t,this.dateAccess=this.config.dateAccess||N,this.locationFilters=this.config.locationFilters||[],this.dateFilters=this.config.dateFilters||[],this.datasetFilters=this.config.datasetFilters||[],this.filters={},this.cache=new B,this.config.filters&&(this.filters.locations=this.config.filters.locations||[],this.filters.dates=this.config.filters.dates||[],this.filters.datasets=this.config.filters.datasets||[])}getFlatDataCombinedStacks(){return L(this.flatData)}getFlatDataCombinedDates(){return F(this.flatData)}getFlatDataCombinedLocations(){return T(this.flatData)}getSumOfLabel(t){return function(t,e){return O(t.filter((t=>t.label===e)))}(this.flatData,t)}getSumOfDataset(t){return function(t,e){return O(t.filter((t=>t.dataset===e)))}(this.flatData,t)}getSumOfStack(t){return A(this.flatData,t)}getMax(){return s.max(this.datasets,(function(t){return s.max(t.data,(function(t){return t.value}))}))}getColorForDataset(t){return this.datasetsColorsController.colorForDataset(t)}getColorForStack(t){return this.datasetsColorsController.colorForStack(t)}getColorsForStack(t){return this.datasetsColorsController.colorsForStack(t)}getFilename(){if(!this.labels)return"Unknown";let t=this.labels.map((t=>t.replaceAll(" ","-")));return t.length>10&&(t=t.splice(0,10)),t.join(",")}}E.NotificationReason={none:"none",registration:"registration",datasetsSet:"datasets-set",datasetsUpdate:"datasets-update",filterDataset:"dataset-filter",filterDates:"dates-filter",filterLocations:"location-filter",resetFilters:"reset-filters"},x.prototype.setDatasetsController=function(t){this.datasetController&&this.datasetController.removeListener(this),this.datasetController=t,this.datasetController.addListener(this),this.update(t,"registration")},x.prototype.setDatasets=function(t){this.setDatasetsController(new E(t))},x.prototype.getDatasets=function(){return this.datasetController&&Array.isArray(this.datasetController.datasets)?this.datasetController.datasets:[]};class j extends p{constructor(t){super(t),this.injectCard(),this.injectHeader(),this.injectBody(),this.injectFooter()}injectCard(){this.element=this.parent.append("div").classed("lotivis-card",!0)}injectHeader(){this.header=this.element.append("div").attr("class","lotivis-card-header"),this.headerRow=this.header.append("div").attr("class","lotivis-row"),this.headerLeftComponent=this.headerRow.append("div").attr("class","lotivis-card-header-left"),this.headerCenterComponent=this.headerRow.append("div").attr("class","lotivis-card-header-center"),this.headerRightComponent=this.headerRow.append("div").attr("class","lotivis-card-header-right lotivis-button-group"),this.titleLabel=this.headerLeftComponent.append("div").attr("class","lotivis-title-label")}injectBody(){this.body=this.element.append("div").attr("class","lotivis-card-body"),this.content=this.body.append("div").attr("class","lotivis-card-body-content")}injectFooter(){this.footer=this.element.append("div").attr("class","lotivis-card-footer"),this.footerRow=this.footer.append("div").attr("class","lotivis-row"),this.footerLeftComponent=this.footerRow.append("div").attr("class","lotivis-col-6"),this.footerRightComponent=this.footerRow.append("div").attr("class","lotivis-col-6"),this.footer.style("display","none")}setTitle(t){this.titleLabel.text(t)}showFooter(){this.footer.style("display","")}hideFooter(){this.footer.style("display","none")}}class I extends p{constructor(t){super(t),this.renderInput(),this.renderLabel()}renderInput(){let t=this;this.element=this.parent.classed("radio-group",!0).append("input").attr("type","checkbox").attr("id",this.selector).on("click",(function(e){if(!e.target)return;let s=e.target;t.onClick&&t.onClick(s.checked)}))}renderLabel(){this.label=this.parent.append("label").attr("for",this.selector).text("Unknown")}setText(t){return this.label.text(t),this}setChecked(t){return this.element.attr("checked",!0===t?t:null),this}onClick(t){console.log("onClick: "+t)}enable(){this.element.attr("disabled",null),this.label.style("color","black")}disable(){this.element.attr("disabled",!0),this.label.style("color","gray")}}class G extends p{constructor(t=d3.select("body")){super(t),this.injectUnderground(t),this.injectContainer(),this.injectCard(),this.inject(),this.injectCloseButton(),this.addCloseActionListeners()}inject(){}injectUnderground(t){this.modalBackgroundId=a(),this.modalBackground=t.append("div").classed("lotivis-popup-underground lotivis-fade-in",!0).attr("id",this.modalBackgroundId)}injectContainer(){this.elementId=a(),this.element=this.modalBackground.append("div").classed("lotivis-popup",!0).attr("id",this.elementId)}injectCard(){this.card=new j(this.element),this.card.element.classed("lotivis-popup",!0)}injectCloseButton(){this.closeButton=new f(this.card.headerRightComponent),this.closeButton.element.classed("lotivis-button-small",!0),this.closeButton.setText("Close")}addCloseActionListeners(){let t=[this.closeButton.selector,this.modalBackgroundId],e=this;this.modalBackground.on("click",(function(s){s&&s.target&&t.includes(s.target.id)&&e.dismiss()}))}willShow(){}didShow(){}show(){this.willShow&&this.willShow(),this.getUnderground().style.display="block",this.didShow&&this.didShow()}willDismiss(){}willRemoveDOMElement(){}dismiss(){this.willDismiss&&this.willDismiss(),this.getUnderground().style.display="none",this.willRemoveDOMElement&&this.willRemoveDOMElement(),this.getUnderground().remove()}getUnderground(){return document.getElementById(this.modalBackgroundId)}showUnder(t,e="center"){if(!t)return;let s=this.preferredSize(),a=this.calculateBottomCenter(t);a.x-="left"===e?a.width/2:"right"===e?s.width-a.width/2:s.width/2;let i=this.elementId,r=document.getElementById(i);r.style.position="absolute",r.style.width=s.width+"px",r.style.left=a.x+"px",r.style.top=a.y+"px",this.show()}showBigModal(){let t=this.elementId,e=document.getElementById(t),s=this.preferredSize();e.style.position="relative",e.style.margin="50px auto",e.style.width=s.width+"px",this.show()}preferredSize(){return{width:300,height:300}}calculateBottomCenter(t,e=!1){let s=t.getBoundingClientRect(),a=s.x+s.width/2,i=s.y+s.height;return e&&(a+=window.scrollX,i+=window.scrollY),{x:a,y:i,width:s.width,height:s.height}}}class $ extends p{constructor(t){super(t),this.inputElements=[],this.selector=a(),this.element=t.append("div").classed("dropdown-container",!0),this.selectId=a(),this.renderLabel(),this.renderSelect()}renderLabel(){this.label=this.element.append("label").attr("for",this.selectId)}renderSelect(){let t=this;this.select=this.element.append("select").attr("id",this.selectId).on("change",(function(e){t.onClick(e)}))}addOption(t,e){return this.select.append("option").attr("id",t).attr("value",t).text(e)}setOptions(t){this.removeAllInputs();for(let e=0;e<t.length;e++){let s;Array.isArray(t[e])?(t[e][0]||t[e].id,s=t[e][1]||t[e].translatedTitle):"string"==typeof t[e]?(t[e],s=t[e]):(t[e].id,s=t[e].title);let a=this.addOption(s,s);this.inputElements.push(a)}return this}removeAllInputs(){return this.element.selectAll("input").remove(),this}onClick(t){let e=t.target;if(!e)return;let s=e.value;return this.onChange?(this.onChange(s),this):void 0}onChange(t){return console.log("argument: "+t),"string"!=typeof t&&(this.onChange=t),this}setLabelText(t){return this.label.text(t),this}setOnChange(t){return this.onChange=t,this}setSelectedOption(t){return void 0!==this.inputElements.find((function(e){return e.attr("value")===t}))&&(this.value=t),this}set value(t){document.getElementById(this.selectId).value=t}get value(){return document.getElementById(this.selectId).value}}$.create=function(t,e,s,a){let i=d3.select("#"+t),r=new $(i);return r.setLabelText("Group Size"),r.setOptions(e),r.setSelectedOption(s),r.setOnChange(a),r};class P extends j{constructor(t){super(t),this.render(),this.updateSensible=!0,this.config?(this.textarea.attr("rows",this.config.lines||25),this.setTitle(this.config.title||this.getClassname())):(this.textarea.attr("rows",25),this.setTitle(this.getClassname()))}render(){this.textareaID=a(),this.textarea=this.body.append("textarea").attr("id",this.textareaID).attr("name",this.textareaID).attr("class","lotivis-data-textarea").on("keyup",this.onKeyup.bind(this)),this.downloadButton=new f(this.headerRightComponent),this.downloadButton.setText("Download"),this.downloadButton.onClick=function(t){let e=this.getTextareaContent();this.download(e)}.bind(this)}getTextareaContent(){return document.getElementById(this.textareaID).value||""}setTextareaContent(t){let e=document.getElementById(this.textareaID);if(!e)return;if(e.value=t,this.config&&!0!==this.config.updatesHeight)return;if("string"!=typeof t)return;let s=t.split("\n").length;this.textarea.attr("rows",s)}enableTextarea(){this.textarea.attr("disabled",null),[this.textarea,this.titleLabel].forEach((t=>t.classed("lotivis-disabled",!1)))}disableTextarea(){this.textarea.attr("disabled",""),[this.textarea,this.titleLabel].forEach((t=>t.classed("lotivis-disabled",!0)))}onKeyup(t){throw new u("onKeyup(event)")}download(t){throw new u("download(content)")}}class M extends P{constructor(t={}){super(t),this.updateSensible=!0,this.downloadButton.hide()}setDatasetsController(t){this.datasetsController=t,this.datasetsController.addListener(this)}update(t,e){if(!this.updateSensible)return void C(`[lotivis]  NOT sensible ${this}. Reason '${e}'.`);if(this.config&&!1===this.config.updateSensible)return void C(`[lotivis]  NOT sensible (Config) ${this}. Reason '${e}'.`);if(!t)return void C(`[lotivis]  NO controller ${this}. Reason '${e}'.`);let s=t.datasets,a=this.datasetsToText(t,s);this.setTextareaContent(a),this.cachedDatasets=s,C(`[lotivis]  Update ${this}. Reason '${e}'.`)}datasetsToText(t,e){throw new u("Subclasses should override.")}}function z(t){if(!t)throw new d("No dataset given.");if(!Array.isArray(t))throw new d("Expecting array of datasets.");for(let e=0;e<t.length;e++)J(t[e])}function J(t){if(!t)throw new d("No dataset given.");if(!t.label)throw new c("Missing label for dataset. "+t);if(!t.data)throw new c("Invalid data. Property is not an array. Dataset: "+t.label);if(!Array.isArray(t.data))throw new d("Invalid data. Property is not an array. Dataset: "+t.label);let e=t;for(let t=0;t<e.length;t++)U(e[t])}function U(t){if(!t.date)throw new c("Missing date property for item.",t);if(!t.location)throw new c("Missing location property for item.",t)}function V(t,e){return String(t)===String(e)}function H(t,e){if(t===e)return!0;return JSON.stringify(t)===JSON.stringify(e)}class W extends M{constructor(t){super(t),this.toast=new m(this.parent),this.downloadButton.show()}onKeyup(){this.updateDatasetsOfController.bind(this)(!0)}updateDatasetsOfController(t=!1){let e=this.getTextareaContent();this.toast.setStatusMessage(null);try{let s=this.textToDatasets(e);if(!s)return;if(z(s),!0===t){if(!this.datasetsController)return C("[lotivis]  No datasets controller.");if(H(this.cachedDatasets,s))return C("[lotivis]  No changes in datasets.");this.cachedDatasets=s,this.updateSensible=!1,this.datasetsController.setDatasets(s),this.updateSensible=!0}}catch(t){C("[lotivis]  ERROR: "+t),this.toast.setStatusMessage(t)}}datasetsToText(t){return new u("datasetsToText(datasets)")}}function q(t,e){return""===e||"."===e?t:(e=e.startsWith(".")?e:"."+e,t.endsWith(e)?t:`${t}${e}`)}function Y(){let t=[w.downloadFilePrefix],e=w.filenameSeparator;for(let e=0;e<arguments.length;e++)t.push(String(arguments[e]));return t.join(e)}function K(t,e){if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(t,e);else{let s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s)}}function _(t,e){K(new Blob([t],{type:"text/csv"}),q(e,"csv"))}function X(t,e){console.log("selector:"+t),console.log("filename:"+e);let s=d3.select("#"+t).node(),a=function(t){let e=t.viewBox.baseVal;return 0!==e.width&&0!==e.height?[e.width,e.height]:[t.width.baseVal.value,t.height.baseVal.value]}(s);!function(t,e,s,a){let i="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(t))),r=document.createElement("canvas");r.width=e,r.height=s;let n=r.getContext("2d"),o=new Image;o.onload=function(){n.clearRect(0,0,e,s),n.drawImage(o,0,0,e,s);let t=r.toDataURL("image/png");a&&a(t)},o.src=i}(function(t){t.setAttribute("xlink","http://www.w3.org/1999/xlink"),function(t,e){let s=document.createElement("style");s.setAttribute("type","text/css"),s.innerHTML=t;let a=e.hasChildNodes()?e.children[0]:null;e.insertBefore(s,a)}(function(t){let e=[];e.push("#"+t.id);for(let s=0;s<t.classList.length;s++)i("."+t.classList[s],e)||e.push("."+t.classList[s]);let s=t.getElementsByTagName("*");for(let t=0;t<s.length;t++){let a=s[t].id;i("#"+a,e)||e.push("#"+a);let r=s[t].classList;for(let t=0;t<r.length;t++)i("."+r[t],e)||e.push("."+r[t])}let a="";for(let t=0;t<document.styleSheets.length;t++){let s=document.styleSheets[t];try{if(!s.cssRules)continue}catch(t){if("SecurityError"!==t.name)throw t;continue}let r=s.cssRules;for(let t=0;t<r.length;t++)i(r[t].selectorText,e)&&(a+=r[t].cssText)}return a;function i(t,e){return-1!==e.indexOf(t)}}(t),t);let e=(new XMLSerializer).serializeToString(t);return e=e.replace(/(\w+)?:?xlink=/g,"xmlns:xlink="),e=e.replace(/NS\d+:href/g,"xlink:href"),e}(s),2*a[0],2*a[1],(function(t){console.log("dataURL:"+t),fetch(t).then((t=>t.blob())).then((function(t){let s=q(e,"png");console.log("saveFilename:"+s),K(t,s)}))}))}const Z=t=>{const e=new RegExp('(\\,|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^\\,\\r\\n]*))',"gi");let s=null,a=[[]];for(;s=e.exec(t);)s[1].length&&","!==s[1]&&a.push([]),a[a.length-1].push(s[2]?s[2].replace(new RegExp('""',"g"),'"'):s[3]);return a};function Q(t,e){const s=String(t),a=[...s].findIndex((t=>t!==e)),i=[...s].reverse().findIndex((t=>t!==e));return s.substring(a,s.length-i)}function tt(t){let e={};for(let s=0;s<t.length;s++){let a=t[s];U(a);let i=a.dataset||a.label,r=e[i];r?r.data.push({date:a.date,location:a.location,value:a.value}):e[i]={label:i,stack:a.stack,data:[{date:a.date,location:a.location,value:a.value}]}}let s=[],a=Object.getOwnPropertyNames(e);for(let t=0;t<a.length;t++){let i=a[t];0!==i.length&&s.push(e[i])}return s}function et(t){let e=[],s=Z(t),a=s.shift();for(let t=0;t<s.length;t++){let a=s[t].map((t=>Q(t,'"')));a.length<5?C("Skipping row: "+a):e.push({label:a[0],stack:a[1],value:+a[2],date:a[3],location:a[4]})}let i=tt(e);return i.csv={content:t,headlines:a,lines:s},i}function st(t){let e=[],s=t;for(let t=0;t<s.length;t++){let a=at(s[t]);e=e.concat(a)}return e}function at(t){let e=[];return t.data?(t.data.forEach((s=>{let a={};a.dataset=t.label,a.label=t.label,a.stack=t.stack||t.label,a.location=s.location,a.date=s.date,a.dateNumeric=s.dateNumeric,a.value=s.value,e.push(a)})),e):(console.log("Lotivis: Flat samples for dataset without samples requested. Will return an empty array."),e)}function it(t){return`"${t}"`}function rt(t){let e=Z(t),s=e.shift();s.shift();let a=[],i=s.length;for(let t=0;t<s.length;t++)a.push({label:s[t],data:[]});for(let t=0;t<e.length;t++){let s=e[t].map((t=>Q(t,'"')));if(s.length<i)continue;let r=s.shift();for(let t=0;t<s.length;t++){let e=s[t];a[t].data.push({date:r,value:e})}}return a.csv={content:t,headlines:s.push(),lines:e},a}function nt(t){return ut(t.map((t=>k(t.label))))}function ot(t){return ut(t.map((t=>k(t.stack||t.label))))}function lt(t){return ct(st(t))}function ht(t){return dt(st(t))}function ct(t){return ut(t.map((t=>k(t.date))))}function dt(t){return ut(t.map((t=>k(t.location))))}function ut(t){return Array.from(new Set(t))}function pt(t,e=(t=>t)){return function(t,e=(t=>t)){return ct(t).sort(((t,s)=>e(t)-e(s))).shift()}(gt(t),e)}function ft(t,e=(t=>t)){return function(t,e=(t=>t)){return ct(t).sort(((t,s)=>e(t)-e(s))).pop()}(gt(t),e)}function gt(t){return t.filter((t=>(t.value||0)>0))}function mt(t,e){let s=st(t);s=F(s);let a=lt(t);a=a.reverse();let i=nt(t);return a.map((function(t){let e={date:t};s.filter((e=>e.date===t)).forEach((function(t){e[t.dataset]=t.value,e.total=t.dateTotal}));for(let t=0;t<i.length;t++){let s=i[t];e[s]||(e[s]=0)}return e}))}class bt extends M{constructor(t){super(t),this.config||(this.config={}),this.config.updatesHeight=this.config.updatesHeight||!0,this.disableTextarea()}datasetsToText(t){if(!this.datasetsController)return"No datasets controller.";let e=this.getDataview();return JSON.stringify(e,null,2)}getDataview(){}}class wt{constructor(t){this.render=function(){let e=t.config.height,s=t.config.margin;t.svg.append("g").call(d3.axisLeft(t.yChart)).attr("transform",(()=>`translate(${s.left},0)`)),t.svg.append("g").call(d3.axisBottom(t.xChart)).attr("transform",(()=>`translate(0,${e-s.bottom})`))}}}class yt{constructor(t){this.renderBarLabels=function(e){let s=t.xChart,a=t.yChart,i=t.xStack,r=t.numberFormat,n=t.labelColor,o=e.length,l=0,h=i.bandwidth()/2;t.svg.append("g").selectAll("g").data(e).enter().append("g").attr("fill",n).selectAll(".text").data((t=>t)).enter().append("text").attr("class","lotivis-date-chart-label").attr("transform",(function(t){return`translate(${s(t.data.date)+i(e.label)+h},${a(t[1])-5})rotate(-60)`})).text((function(t,e){if(0===e&&(l+=1),l!==o)return;let s=t[1];return 0===s?"":r.format(s)}))}}}class vt{constructor(t){this.renderNormalLegend=function(){let e=t.config,s=t.datasetController,a=s.datasets,i=s.labels,r=d3.scaleBand().domain(i).rangeRound([e.margin.left,e.width-e.margin.right]),n=t.graph.selectAll(".legend").data(a).enter();n.append("text").attr("class","lotivis-date-chart-legend-label").attr("font-size",13).attr("x",(t=>r(t.label)-30)).attr("y",t.graphHeight+50).style("cursor","pointer").style("fill",(function(t){return s.getColorForDataset(t.label)})).text((t=>`${t.label} (${s.getSumOfDataset(t.label)})`)).on("click",function(e){if(!e||!e.target)return;if(!e.target.innerHTML)return;let s=e.target.innerHTML.split(" (");s.pop();let a=s.join(" (");t.toggleDataset(a)}.bind(this)),n.append("circle").attr("class","lotivis-date-chart-legend-circle").attr("r",6).attr("cx",(t=>r(t.label)-12-30)).attr("cy",t.graphHeight+50-6+2).style("stroke",(t=>s.getColorForDataset(t.label))).style("fill",function(t){return t.isEnabled?s.getColorForDataset(t.label):"white"}.bind(this))},this.renderCombinedStacksLegend=function(){let s=t.datasetController.stacks,a=d3.scaleBand().domain(s).rangeRound([t.config.margin.left,t.config.width-t.config.margin.right]),i=t.graph.selectAll(".lotivis-date-chart-legend-label").data(s).enter();i.append("text").attr("class","lotivis-date-chart-legend-label").attr("font-size",23).attr("x",(t=>a(t)-30)).attr("y",function(){return t.graphHeight+50}.bind(this)).style("cursor","pointer").style("fill",function(t,s){return e.colorsForStack(s)[0].rgbString()}.bind(this)).text(function(e){return`${e} (${A(t.datasetController.flatData,e)})`}.bind(this)),i.append("circle").attr("r",6).attr("cx",(t=>a(t)-12-30)).attr("cy",t.graphHeight+50-6+2).style("cursor","pointer").style("stroke",function(t,s){return e.colorsForStack(s)[0].rgbString()}.bind(this)).style("fill",function(t,s){return t.isEnabled?e.colorsForStack(s)[0].rgbString():"white"}.bind(this)).style("stroke-width",2)}}}class Ct{constructor(t){this.renderBars=function(e){let s=t.config||{},a=s.combineStacks||!1,i=t.datasetController.getColorsForStack(e.stack)||Color.defaultTint,r=s.barRadius||w.barRadius;t.svg.append("g").selectAll("g").data(e).enter().append("g").attr("fill",((t,s)=>a?i[0]:e.colors[s])).selectAll("rect").data((t=>t)).enter().append("rect").attr("class","lotivis-date-chart-bar").attr("rx",a?0:r).attr("ry",a?0:r).attr("x",(s=>t.xChart(s.data.date)+t.xStack(e.label))).attr("y",(e=>t.yChart(e[1]))).attr("width",t.xStack.bandwidth()).attr("height",(e=>t.yChart(e[0])-t.yChart(e[1])))}}}class xt{constructor(t){function e(t){return"ghost-rect-"+r(String(t))}function s(s,a){this.hideAll();let i=t.datasetController,r=e(a);t.config.sendsNotifications&&(t.updateSensible=!1,i.setDatesFilter([a]),t.updateSensible=!0),t.svg.select("#"+r).attr("opacity",.3),t.tooltipRenderer.showTooltip(s,a)}function a(e,s){this.hideAll(),t.tooltipRenderer.hideTooltip(e,s),t.config.sendsNotifications&&(t.updateSensible=!1,t.datasetController.resetFilters(),t.updateSensible=!0)}this.hideAll=function(){t.svg.selectAll(".lotivis-selection-rect").attr("opacity",0)},this.renderGhostBars=function(){let i=t.config.margin,r=t.config.dateLabels||t.dataview.dates;t.svg.append("g").selectAll("rect").data(r).enter().append("rect").attr("class","lotivis-selection-rect").attr("id",(t=>e(t))).attr("opacity",0).attr("rx",w.barRadius).attr("ry",w.barRadius).attr("x",(e=>t.xChart(e))).attr("y",i.top).attr("width",t.xChart.bandwidth()).attr("height",t.config.height-i.bottom-i.top).on("mouseenter",s.bind(this)).on("mouseout",a.bind(this))}}}class St{constructor(t){const e=t.element.append("div").attr("class","lotivis-tooltip").attr("rx",5).attr("ry",5).style("opacity",0);this.showTooltip=function(s,a){e.html(function(e){let s,a=t.datasetController.enabledFlatData().filter((t=>t.date===e)),i=a.first();return s=i&&i.from&&i.till?`${i.from} - ${i.till}`:""+e,`<b>${s}</b><br>${F(a).filter((t=>t.value>0)).map((function(e){let s=t.datasetController.getColorForDataset(e.dataset);return`<div style="background: ${s};color: ${s}; display: inline;">__</div> ${e.dataset}: <b>${e.value}</b>`})).join("<br>")}`}(a));let i=[Number(e.style("width").replace("px","")),Number(e.style("height").replace("px",""))],r=t.getElementEffectiveSize()[0]/t.config.width,n=t.getElementPosition(),o=function(e,s,a){let i=t.config.margin.top*e;return i+=(t.graphHeight*e-a[1])/2,i+=s[1]-10,i}(r,n,i),l=t.xChart(a);l=l>t.config.width/2?function(e,s,a,i){return t.xChart(e)*s+a[0]-i[0]-22-w.tooltipOffset}(a,r,n,i):function(e,s,a){let i=t.xChart(e)+t.xChart.bandwidth();return i*=s,i+=a[0]+w.tooltipOffset,i}(a,r,n),e.style("left",l+"px").style("top",o+"px").style("opacity",1)},this.hideTooltip=function(){0!=+e.style("opacity")&&e.style("opacity",0)}}}class Dt{constructor(t){this.createAxis=function(){this.xAxisGrid=d3.axisBottom(t.xChart).tickSize(-t.graphHeight).tickFormat(""),this.yAxisGrid=d3.axisLeft(t.yChart).tickSize(-t.graphWidth).tickFormat("").ticks(20)},this.renderGrid=function(){let e=t.config,s="lightgray";t.svg.append("g").attr("class","x axis-grid").attr("transform","translate(0,"+(e.height-e.margin.bottom)+")").attr("stroke",s).attr("stroke-width","0.5").attr("opacity",.3).call(this.xAxisGrid),t.svg.append("g").attr("class","y axis-grid").attr("transform",`translate(${e.margin.left},0)`).attr("stroke",s).attr("stroke-width","0.5").attr("opacity",.3).call(this.yAxisGrid)}}}const kt={width:1e3,height:600,margin:{top:w.defaultMargin,right:w.defaultMargin,bottom:w.defaultMargin,left:w.defaultMargin},showLabels:!1,combineStacks:!1,sendsNotifications:!0,labelColor:new e(155,155,155),numberFormat:Intl.NumberFormat("de-DE",{maximumFractionDigits:3}),dateAccess:function(t){return Date.parse(t)}};class Rt extends x{initialize(){this.initializeDefaultValues(),this.initializeRenderers()}initializeDefaultValues(){let t;this.config,t=Object.assign({},kt.margin),t=Object.assign(t,this.config.margin);let s=Object.assign({},kt);this.config=Object.assign(s,this.config),this.config.margin=t,this.datasets=[],this.labelColor=new e(155,155,155).rgbString(),this.type="bar",this.numberFormat=new Intl.NumberFormat("de-DE",{maximumFractionDigits:3})}initializeRenderers(){this.axisRenderer=new wt(this),this.gridRenderer=new Dt(this),this.labelRenderer=new yt(this),this.legendRenderer=new vt(this),this.barsRenderer=new Ct(this),this.ghostBarsRenderer=new xt(this),this.tooltipRenderer=new St(this)}remove(){this.element.selectAll("svg").remove()}precalculate(){let t=this.config,e=t.margin;if(this.graphWidth=t.width-e.left-e.right,this.graphHeight=t.height-e.top-e.bottom,!this.datasetController)return;let s=this.config.groupSize||1;this.config.combineStacks?this.dataview=this.datasetController.getDateDataviewCombinedStacks(s):this.dataview=this.datasetController.getDateDataview(s),this.createScales()}createScales(){let t=this.config,e=t.margin;if(!this.dataview)return;let s=t.dateLabels||this.dataview.dates;this.xChart=d3.scaleBand().domain(s).rangeRound([e.left,t.width-e.right]).paddingInner(.1),this.xStack=d3.scaleBand().domain(this.dataview.enabledStacks).rangeRound([0,this.xChart.bandwidth()]).padding(.05),this.yChart=d3.scaleLinear().domain([0,this.dataview.max]).nice().rangeRound([t.height-e.bottom,e.top])}draw(){if(this.renderSVG(),this.dataview&&this.dataview.datasetStacks&&0!==this.dataview.datasetStacks.length){this.axisRenderer.render(),this.gridRenderer.createAxis(),this.gridRenderer.renderGrid(),this.ghostBarsRenderer.renderGhostBars(),this.config.combineStacks?this.legendRenderer.renderCombinedStacksLegend():this.legendRenderer.renderNormalLegend();for(let t=0;t<this.dataview.datasetStacksPresented.length;t++){let e=this.dataview.datasetStacksPresented[t];this.barsRenderer.renderBars(e,t),!1!==this.config.showLabels&&this.labelRenderer.renderBarLabels(e,t)}}}renderSVG(){this.svg=this.element.append("svg").attr("class","lotivis-chart-svg lotivis-date-chart").attr("preserveAspectRatio","xMidYMid meet").attr("viewBox",`0 0 ${this.config.width} ${this.config.height}`).attr("id",this.svgSelector),this.background=this.svg.append("rect").attr("width",this.config.width).attr("height",this.config.height).attr("fill","white").attr("opacity",0),this.graph=this.svg.append("g").attr("width",this.graphWidth).attr("height",this.graphHeight).attr("transform",`translate(${this.config.margin.left},${this.config.margin.top})`)}toggleDataset(t){this.datasetController.toggleDataset(t,!0===this.config.sendsNotifications),this.update()}}class Lt{static getInstance(){return Lt.instance||(Lt.instance=new Lt),Lt.instance}getURL(){return new URL(window.location.href)}getBoolean(t,e=!1){let s=this.getURL().searchParams.get(t);return s?"true"===s:e}getString(t,e=""){return this.getURL().searchParams.get(t)||e}set(t,e){const s=this.getURL();!1===e?s.searchParams.delete(t):s.searchParams.set(t,e),window.history.replaceState(null,null,s),this.updateCurrentPageFooter()}setWithoutDeleting(t,e){const s=this.getURL();s.searchParams.set(t,e),window.history.replaceState(null,null,s),this.updateCurrentPageFooter()}clear(){const t=this.getURL(),e=t.protocol+t.host,s=new URL(e);window.history.replaceState(null,null,s),this.updateCurrentPageFooter()}updateCurrentPageFooter(){}}Lt.language="language",Lt.page="page",Lt.query="query",Lt.searchViewMode="search-view-mode",Lt.chartType="chart-type",Lt.chartShowLabels="chart-show-labels",Lt.chartCombineStacks="chart-datasetCombine-stacks",Lt.contentType="content-type",Lt.valueType="value-type",Lt.searchSensitivity="search-sensitivity",Lt.startYear="start-year",Lt.endYear="end-year",Lt.showTestData="show-samples";class Ft extends G{constructor(t){super(t)}inject(){super.inject(),this.card.setTitle("Settings"),this.card.content.classed("lotivis-card-body-settings",!0),this.row=this.card.content.append("div").classed("lotivis-row",!0)}preferredSize(){return{width:240,height:600}}}class Tt extends Ft{inject(){super.inject(),this.injectShowLabelsCheckbox(),this.injectCombineStacksCheckbox(),this.injectRadios()}injectShowLabelsCheckbox(){let t=this.row.append("div");this.showLabelsCheckbox=new I(t),this.showLabelsCheckbox.setText("Labels"),this.showLabelsCheckbox.onClick=function(t){this.chart.config.showLabels=t,this.chart.update(),Lt.getInstance().set(Lt.chartShowLabels+this.selector,t)}.bind(this)}injectCombineStacksCheckbox(){let t=this.row.append("div");this.combineStacksCheckbox=new I(t),this.combineStacksCheckbox.setText("Combine Stacks"),this.combineStacksCheckbox.onClick=function(t){this.chart.config.combineStacks=t,this.chart.update(),Lt.getInstance().set(Lt.chartCombineStacks+this.selector,t)}.bind(this)}injectRadios(){let t=this.row.append("div");this.typeRadioGroup=new g(t),this.typeRadioGroup.setOptions([new b("bar","Bar"),new b("line","Line")]),this.typeRadioGroup.onChange=function(t){this.chart.type=t,this.chart.update(),Lt.getInstance().set(Lt.chartType+this.selector,t)}.bind(this)}willShow(){this.showLabelsCheckbox.setChecked(this.chart.config.showLabels),this.combineStacksCheckbox.setChecked(this.chart.config.combineStacks),this.typeRadioGroup.setSelectedOption(this.chart.type)}}class At extends j{constructor(t,e){t&&e&&"string"==typeof t?(e.selector=t,super(e)):super(t),this.chart=null,this.config=e,this.injectButtons(),this.injectRadioGroup(),this.injectChart();let s=this.selector;this.setTitle(e&&e.title?e.title:s||"No Title")}injectChart(){return new u("injectChart()")}injectButtons(){this.screenshotButton=new f(this.headerRightComponent),this.screenshotButton.setText("Screenshot"),this.screenshotButton.element.classed("simple-button",!0),this.screenshotButton.onClick=this.screenshotButtonAction.bind(this),this.moreButton=new f(this.headerRightComponent),this.moreButton.setText("More"),this.moreButton.element.classed("simple-button",!0),this.moreButton.onClick=this.presentSettingsPopupAction.bind(this)}injectRadioGroup(){this.radioGroup=new g(this.headerCenterComponent),this.radioGroup.onChange=function(t){let e=this.datasets.find((function(e){return!!e.label&&e.label.replaceAll(" ","-")===t}));if(!e)return C("Can't find dataset with label "+t);this.setDataset(e)}.bind(this)}updateRadioGroup(){if(!this.datasets)return;let t=this.datasets.map((t=>t.label||"Unknown Label")).map((t=>new b(t)));this.radioGroup.setOptions(t)}setDatasets(t){this.datasets=t,this.updateRadioGroup();let e=t[0];this.setDataset(e)}setDataset(t){if(C("this.chart: "+this.chart),C("this.chart: ",t),this.chart&&(Array.isArray(t)?this.chart.setDatasets(t):this.chart.setDatasets([t]),this.onSelectedDatasetChanged)){let e=t.stack||t.label||"Unknown",s=(this.datasets||[]).indexOf(t);this.onSelectedDatasetChanged(t,s,e)}}screenshotButtonAction(){return new u("screenshotButtonAction()")}presentSettingsPopupAction(){return new u("presentSettingsPopupAction()")}onSelectedDatasetChanged(){return new u("onSelectedDatasetChanged()")}}const Ot=new Intl.NumberFormat("de-DE",{maximumFractionDigits:3});function Nt(t){return"number"!=typeof t?t:Ot.format(t)}class Bt{constructor(t){this.mapChart=t;let e=t.element.append("div").attr("class","lotivis-tooltip").attr("rx",5).attr("ry",5).style("opacity",0);function s(e){return`ID: ${t.config.featureIDAccessor(e)}<br>Name: ${t.config.featureNameAccessor(e)}`}function a(e){let s=[],a=t.config.featureIDAccessor(e);if(t.datasetController){let e=T(t.datasetController.flatData).filter((t=>V(t.location,a)));s.push("");for(let t=0;t<e.length;t++){let a=e[t],i=a.label||a.dataset||a.stack;s.push(i+": "+Nt(a.value))}}return s.join("<br>")}this.mouseEnter=function(i,r){e.html([s(r),a(r)].join("<br>"));let n=[Number(e.style("width").replace("px","")||200)+20,Number(e.style("height").replace("px",""))+20],o=t.projection,l=d3.geoBounds(r),h=o(l[0]),c=o(l[1]),d=c[0]-h[0],u=t.getElementEffectiveSize()[0]/t.config.width,p=t.getElementPosition();let f=0;f=h[1]>t.config.height/2?function(){let t=c[1]*u;return t-=n[1],t+=p[1],t-=w.tooltipOffset,t}():function(){let t=h[1]*u;return t+=p[1],t+=w.tooltipOffset,t}();let g=function(){let t=h[0];return t+=d/2,t*=u,t-=n[0]/2,t+=p[0],t}();e.style("opacity",1).style("left",g+"px").style("top",f+"px"),t.onSelectFeature(i,r)},this.mouseOut=function(s,a){let i=function(t){let e=t;e.startsWith(".")||(e="."+e);let s=document.querySelector(e);return s&&getComputedStyle(s)||{}}(".lotivis-map-area"),r=function(e){return"lotivis-map-area-"+t.config.featureIDAccessor(e)}(a);t.svg.select("#"+r).style("stroke",i.stroke||"black").style("stroke-width",i["stroke-width"]||"0.7").style("stroke-dasharray",(t=>t.departmentsData?"0":"1,4")),e.style("opacity",0)},this.raise=function(){e.raise()}}}class Et{constructor(t){let s;this.render=function(){if(!t.dataview)return;let a=t.dataview.stacks,i=t.dataview.combinedData;s=t.svg.append("svg").attr("class","lotivis-map-legend").attr("width",t.width).attr("height",200).attr("x",0).attr("y",0),s.raise(),s.selectAll("rect").remove(),s.selectAll("text").remove();for(let t=0;t<a.length;t++){let r=a[t],n=i.filter((t=>t.stack===r)),o=d3.max(n,(t=>t.value))||0,l=80*t,h=e.colorsForStack(t,1)[0],c=4,d=[0,1/4*o,.5*o,3/4*o,o],u=e.colorGenerator(o);s.append("text").attr("class","lotivis-map-legend-title").attr("x",l+10).attr("y","20").style("fill",h.rgbString()).text(r),s.append("g").selectAll("rect").data(d).enter().append("rect").attr("class","lotivis-map-legend-rect").style("fill",u).attr("x",l+10).attr("y",((t,e)=>20*e+30)).attr("width",18).attr("height",18).style("stroke","black").style("stroke-width",1),s.append("g").selectAll("text").data(d).enter().append("text").attr("class","lotivis-map-legend-text").attr("x",l+35).attr("y",((t,e)=>20*e+44)).text(((t,e)=>Nt(e/c*o)))}}}}class jt{constructor(t){this.render=function(){t.svg.selectAll(".lotivis-map-label").remove();let e=t.geoJSON;if(!t.geoJSON)return C("[lotivis]  No GeoJSON to render.");let s=t.dataview;return s?t.config.showLabels?void t.svg.selectAll("text").data(e.features).enter().append("text").attr("class","lotivis-map-label").text((function(e){let a=t.config.featureIDAccessor(e),i=s.combinedData.find((t=>V(t.location,a)));return i?Nt(i.value):""})).attr("x",function(e){return t.projection(e.center)[0]}.bind(this)).attr("y",function(e){return t.projection(e.center)[1]}.bind(this)):C("[lotivis]  Skip rendering labels due to configuration."):C("[lotivis]  No dataview in map.")}}}class It{constructor(t){let s=e.colorGenerator(1);this.mouseEnter=function(s,a){let i=e.defaultTint.rgbString(),r=function(e){return"lotivis-map-area-"+t.config.featureIDAccessor(e)}(a);t.svg.selectAll("#"+r).raise().style("stroke",(()=>i)).style("stroke-width","2").style("stroke-dasharray","0"),t.svg.selectAll(".lotivis-map-label").raise()},this.mouseOut=function(){},this.render=function(){if(!t.geoJSON)return C("[lotivis]  No GeoJSON to render.");if(!t.dataview)return C("[lotivis]  No dataview property.");let e=t.dataview.stacks,a=t.dataview.combinedData;for(let i=0;i<e.length;i++){let r=e[i],n=a.filter((t=>t.stack===r)),o=d3.max(n,(t=>t.value));for(let e=0;e<n.length;e++){let a=n[e],i=a.location,r=Number(a.value/o);t.svg.selectAll(".lotivis-map-area").filter((e=>V(t.config.featureIDAccessor(e),i))).style("fill",s(r))}}}}}class Gt{constructor(t){function e(e,s){t.datasetRenderer.mouseEnter(e,s),t.tooltipRenderer.mouseEnter(e,s),t.selectionBoundsRenderer.mouseEnter(e,s)}function s(e,s){t.datasetRenderer.mouseOut(e,s),t.tooltipRenderer.mouseOut(e,s),t.selectionBoundsRenderer.mouseOut(e,s)}this.render=function(){let a=t.presentedGeoJSON;if(!a)return C("[lotivis]  No GeoJSON to render.");let i=t.config.featureIDAccessor;t.areas=t.svg.selectAll("path").data(a.features).enter().append("path").attr("d",t.path).attr("id",(t=>"lotivis-map-area-"+i(t))).classed("lotivis-map-area",!0).style("stroke-dasharray",(t=>t.departmentsData?"0":"1,4")).style("fill","whitesmoke").style("fill-opacity",1).on("click",t.onSelectFeature.bind(t)).on("mouseenter",e).on("mouseout",s)}}}class $t{constructor(t){self.topojson||v("Can't find topojson lib.  Skip rendering of exterior border."),this.render=function(){if(!self.topojson)return void C("[lotivis]  Can't find topojson library.");let e=t.presentedGeoJSON;if(!e)return void C("[lotivis]  No GeoJSON to render.");let s=function(t){let e=topojson.topology(t.features),s=function(t){let e=[];for(const s in t.objects)t.objects.hasOwnProperty(s)&&e.push(t.objects[s]);return e}(e);return{type:"FeatureCollection",features:[{type:"Feature",geometry:topojson.merge(e,s),properties:{code:1,nom:"asdf"}}]}}(e);if(!s)return C("[lotivis]  No borders to render.");t.svg.selectAll("path").append("path").datum(s).attr("d",t.path).attr("class","lotivis-map-exterior-borders")}}}class Pt{constructor(t){this.render=function(){t.minimapFeatureCodes}}}class Mt{constructor(t){this.render=function(){this.bounds=t.svg.append("rect").attr("class","lotivis-map-selection-rect").style("fill-opacity",0)},this.mouseEnter=function(e,s){if(!t.config.drawRectangleAroundSelection)return;let a=t.projection,i=d3.geoBounds(s),r=a(i[0]),n=a(i[1]),o=n[0]-r[0],l=r[1]-n[1];this.bounds.style("width",o+"px").style("height",l+"px").style("x",r[0]).style("y",n[1]).style("opacity",1)},this.mouseOut=function(){this.bounds.style("opacity",0)},this.raise=function(){this.bounds.raise()}}}const zt={width:1e3,height:1e3,margin:{top:w.defaultMargin,right:w.defaultMargin,bottom:w.defaultMargin,left:w.defaultMargin},isShowLabels:!0,geoJSON:null,departmentsData:[],excludedFeatureCodes:[],drawRectangleAroundSelection:!1,sendsNotifications:!0,featureIDAccessor:function(t){return t.id||0===t.id?t.id:t.properties&&D(t.properties.id)?t.properties.id:t.properties&&D(t.properties.code)?t.properties.code:i(t.properties)},featureNameAccessor:function(t){return D(t.name)?t.name:t.properties&&D(t.properties.name)?t.properties.name:t.properties&&D(t.properties.nom)?t.properties.nom:w.unknown}};class Jt{constructor(t){function e(){let e=t.datasetController;if(!e)return;let s=e.locationFilters;s&&0!==s.length&&(t.updateSensible=!1,e.resetFilters(),t.updateSensible=!0)}this.render=function(){t.svg.append("rect").attr("width",t.config.width).attr("height",t.config.height).attr("fill","white").on("mouseenter",e)}}}class Ut{constructor(t){this.type=t.type,this.coordinates=t.coordinates}}class Vt{constructor(t){this.type=t.type,this.properties=t.properties,this.geometry=new Ut(t.geometry)}}class Ht{constructor(t){if(this.type=t.type,this.features=[],t.features)for(let e=0;e<t.features.length;e++){let s=t.features[e],a=new Vt(s);this.features.push(a)}else this.properties=t.properties,this.geometry=new Ut(t.geometry)}getCenter(){let t=this.extractAllCoordinates();console.log("allCoordinates.length: "+t.length);let e=0,s=0;return t.forEach((function(t){e+=t[1],s+=t[0]})),[e/t.length,s/t.length]}extractGeometryCollection(){let t=[];if("Feature"===this.type)t.push(this.geometry);else if("FeatureCollection"===this.type)this.features.forEach((e=>t.push(e.geometry)));else{if("GeometryCollection"!==this.type)throw new Error("The geoJSON is not valid.");this.geometries.forEach((e=>t.push(e)))}return t}extractAllCoordinates(){let t=this.extractGeometryCollection(),e=[];return t.forEach((t=>{let s=t.coordinates,a=t.type;if("Point"===a)console.log("Point: "+s.length),e.push(s);else if("MultiPoint"===a)console.log("MultiPoint: "+s.length),s.forEach((t=>e.push(t)));else if("LineString"===a)console.log("LineString: "+s.length),s.forEach((t=>e.push(t)));else if("Polygon"===a)s.forEach((function(t){t.forEach((function(t){e.push(t)}))}));else if("MultiLineString"===a)s.forEach((function(t){t.forEach((function(t){t.forEach((function(t){e.push(t)}))}))}));else{if("MultiPolygon"!==a)throw new Error("The geoJSON is not valid.");s.forEach((function(t){t.forEach((function(t){t.forEach((function(t){e.push(t)}))}))}))}})),e}}class Wt extends x{constructor(t,e){super(t,e)}initialize(){let t,e=this.config;t=Object.assign({},zt.margin),t=Object.assign(t,e.margin||{});let s=Object.assign({},zt);this.config=Object.assign(s,this.config),this.config.margin=t,this.projection=d3.geoMercator(),this.path=d3.geoPath().projection(this.projection),this.initializeRenderers()}initializeRenderers(){this.backgroundRenderer=new Jt(this),this.geoJSONRenderer=new Gt(this),this.datasetRenderer=new It(this),this.exteriorBorderRenderer=new $t(this),this.minimapRenderer=new Pt(this),this.labelRenderer=new jt(this),this.legendRenderer=new Et(this),this.selectionBoundsRenderer=new Mt(this),this.tooltipRenderer=new Bt(this)}remove(){this.svg&&this.svg.remove()}precalculate(){if(this.renderSVG(),!this.datasetController)return;if(this.dataview=this.datasetController.getLocationDataview(),this.geoJSON)return;let t=function(t){let e=ht(t),s=Math.ceil(e.length/5),a=.1,i=.1,r=[];t:for(let t=0;t<s;t++)for(let s=0;s<5;s++){if(0===e.length)break t;let n=e.shift(),o=(s+1)*a,l=-.1*(t+1),h=[];h.push([o+a,l+i]),h.push([o+a,l]),h.push([o,l]),h.push([o,l+i]),h.push([o+a,l+i]);let c={type:"Feature",id:n,properties:{id:n,code:n,location:n},geometry:{type:"Polygon",coordinates:[h]}};r.push(c)}return{type:"FeatureCollection",features:r}}(this.datasetController.datasets);this.setGeoJSON(t)}draw(){this.backgroundRenderer.render(),this.exteriorBorderRenderer.render(),this.geoJSONRenderer.render(),this.legendRenderer.render(),this.datasetRenderer.render(),this.labelRenderer.render(),this.minimapRenderer.render(),this.tooltipRenderer.raise(),this.selectionBoundsRenderer.render(),this.selectionBoundsRenderer.raise()}renderSVG(){this.svg=this.element.append("svg").attr("id",this.svgSelector).attr("viewBox",`0 0 ${this.config.width} ${this.config.height}`)}zoomTo(t){this.projection.fitSize([this.config.width,this.config.height],t)}onSelectFeature(t,e){if(!e||!e.properties)return;if(!this.datasetController)return;let s=this.config.featureIDAccessor(e);this.updateSensible=!1,this.datasetController.setLocationsFilter([s]),this.updateSensible=!0}setGeoJSON(t){"object"==typeof t&&"GeoJSON"===t.prototype?this.geoJSON=t:this.geoJSON=new Ht(t),this.presentedGeoJSON=this.geoJSON,this.geoJSONDidChange()}geoJSONDidChange(){this.geoJSON&&(this.geoJSON.features.forEach((t=>t.center=d3.geoCentroid(t))),this.presentedGeoJSON=function(t,e){if(!Array.isArray(e))return t;let s=t;for(let t=0;t<e.length;t++){let a=e[t],i=s.features.find((t=>t.properties.code===a));if(!i)continue;let r=s.features.indexOf(i);r<0||s.features.splice(r,1)}return s}(this.geoJSON,this.config.excludedFeatureCodes),this.zoomTo(this.geoJSON))}}class qt extends Ft{inject(){super.inject();let t=this.row.append("div").classed("col-12",!0);this.showLabelsCheckbox=new I(t),this.showLabelsCheckbox.setText("Labels"),this.showLabelsCheckbox.onClick=function(t){this.mapChart.config.showLabels=t,this.mapChart.update(),Lt.getInstance().setWithoutDeleting("map-show-labels",t)}.bind(this)}willShow(){this.showLabelsCheckbox.setChecked(this.mapChart.config.showLabels)}}class Yt{constructor(t){this.renderAxis=function(){let e=t.config.margin;t.svg.append("g").call(d3.axisTop(t.xChart)).attr("transform",(()=>`translate(0,${e.top})`)),t.svg.append("g").call(d3.axisLeft(t.yChart)).attr("transform",(()=>`translate(${e.left},0)`)),t.svg.append("g").call(d3.axisBottom(t.xChart)).attr("transform",(()=>`translate(0,${t.height-e.bottom})`))}}}class Kt{constructor(t){this.plotChart=t,this.colorGenerator=e.plotColor(1)}createGradient(t){let e=this.plotChart.dataView.max,s=this.plotChart.definitions.append("linearGradient").attr("id","lotivis-plot-gradient-"+n(t)).attr("x1","0%").attr("x2","100%").attr("y1","0%").attr("y2","0%"),a=t.data,i=a.length,r=t.lastDate,o=t.duration;if(a&&0!==a.length)if(0===o){let t=a[0].value/e;s.append("stop").attr("offset","100%").attr("stop-color",this.colorGenerator(t))}else for(let t=0;t<i;t++){let i=a[t],n=i.date,l=i.value/e,h=100*(1-(r-n)/o);s.append("stop").attr("offset",h+"%").attr("stop-color",this.colorGenerator(l))}}}class _t{constructor(t){function e(e,s){t.tooltipRenderer.showTooltip.bind(t)(e,s),t.onSelectDataset(e,s)}function s(e,s){t.tooltipRenderer.hideTooltip.bind(t)(e,s)}this.gradientCreator=new Kt(t),t.definitions=t.svg.append("defs"),this.renderBars=function(){let a=t.dataView.datasets;t.definitions=t.svg.append("defs");for(let t=0;t<a.length;t++)this.gradientCreator.createGradient(a[t]);t.barsData=t.svg.append("g").selectAll("g").data(a).enter(),t.bars=t.barsData.append("rect").attr("fill",(t=>`url(#lotivis-plot-gradient-${n(t)})`)).attr("class","lotivis-plot-bar").attr("rx",6).attr("ry",6).attr("x",(e=>t.xChart(e.duration<0?e.lastDate:e.firstDate||0))).attr("y",(e=>t.yChart(e.label))).attr("height",t.yChart.bandwidth()).attr("id",(t=>"rect-"+n(t))).on("mouseenter",e).on("mouseout",s).attr("width",function(e){return e.firstDate&&e.lastDate?t.xChart(e.lastDate)-t.xChart(e.firstDate)+t.xChart.bandwidth():0}.bind(this))}}}class Xt{constructor(t){const e=t.element.append("div").attr("class","lotivis-tooltip").attr("rx",5).attr("ry",5).style("opacity",0);this.showTooltip=function(s,a){if(!t.config.showTooltip)return;e.html(function(t){let e=[];e.push("Label: "+t.label),e.push(""),e.push("Start: "+t.firstDate),e.push("End: "+t.lastDate),e.push(""),e.push("Items: "+t.data.map((t=>t.value)).reduce(((t,e)=>+t+ +e),0)),e.push("");let s=t.data.filter((t=>0!==t.value));for(let t=0;t<s.length;t++){let a=s[t];e.push(`${a.date}: ${a.value}`)}return e.join("<br/>")}(a));let i=Number(e.style("height").replace("px","")),r=t.getElementEffectiveSize()[0]/t.config.width,n=t.getElementPosition(),o=t.yChart(a.label)*r;o+=n[1],t.yChart(a.label)-t.config.margin.top<=t.graphHeight/2?o+=t.config.lineHeight*r+w.tooltipOffset:(o-=i+20,o-=w.tooltipOffset);let l=function(e,s,a){let i=t.xChart(e.firstDate);return i*=s,i+=a[0],i}(a,r,n);e.style("left",l+"px").style("top",o+"px").style("opacity",1)},this.hideTooltip=function(){let s=t.datasetController,a=s.datasetFilters;a&&0!==a.length&&s.resetFilters(),0!=+e.style("opacity")&&e.style("opacity",0)}}}class Zt{constructor(t){this.renderLabels=function(){if(!t.config.isShowLabels)return;let e=t.yChart.bandwidth(),s=t.xChart;t.labels=t.barsData.append("g").attr("transform",`translate(0,${e/2+4})`).append("text").attr("class","lotivis-plot-label").attr("id",(t=>"rect-"+i(t.label))).attr("x",(t=>s(t.firstDate)+e/2)).attr("y",(e=>t.yChart(e.label))).attr("width",(t=>s(t.lastDate)-s(t.firstDate)+e)).text((function(t){if(0!==t.sum)return`${t.duration+1} years, ${t.sum} items`}))}}}class Qt{constructor(t){this.render=function(){t.config.drawGrid&&(t.svg.append("g").attr("class","lotivis-plot-grid lotivis-plot-grid-x").attr("transform","translate(0,"+(t.preferredHeight-t.config.margin.bottom)+")").call(t.xAxisGrid),t.svg.append("g").attr("class","lotivis-plot-grid lotivis-plot-grid-y").attr("transform",`translate(${t.config.margin.left},0)`).call(t.yAxisGrid))}}}class te{constructor(t){this.render=function(){t.svg.append("rect").attr("width",t.width).attr("height",t.height).attr("class","lotivis-plot-background")}}}const ee="alphabetically",se="duration",ae="intensity",ie="firstDate",re={width:1e3,height:600,margin:{top:w.defaultMargin,right:w.defaultMargin,bottom:w.defaultMargin,left:w.defaultMargin},lineHeight:28,radius:23,isShowLabels:!0,drawGrid:!0,showTooltip:!0,lowColor:"rgb(184, 233, 148)",highColor:"rgb(0, 122, 255)",sort:se};E.prototype.getPlotDataview=function(){let t=this.getCached("plot");if(t)return t;this.dateAccess;let e=this.enabledDatasets(),a={datasets:[]};return a.dates=lt(e).sort(),a.labels=nt(e),e.forEach((function(t){let e=function(t,e){let s={},a=S(t.data),i=pt(a)||0,r=ft(a)||0,n=at(t);return s.dataset=t.label,s.label=t.label,s.stack=t.stack,s.firstDate=i,s.lastDate=r,s.sum=O(n),s.data=F(a).sort(((t,e)=>t.dateNumeric-e.dateNumeric)).filter((t=>(t.value||0)>0)),s}(t),s=a.dates.indexOf(e.firstDate),i=a.dates.indexOf(e.lastDate);e.duration=i-s,a.datasets.push(e)})),a.labelsCount=a.datasets.length,a.max=s.max(a.datasets,(function(t){return s.max(t.data,(function(t){return t.value}))})),this.setCached(a,"plot"),a};class ne extends x{initialize(){let t;this.config,t=Object.assign({},re.margin),t=Object.assign(t,this.config.margin);let e=Object.assign({},re);this.config=Object.assign(e,this.config),this.config.margin=t,this.createSVG(),this.backgroundRenderer=new te(this),this.axisRenderer=new Yt(this),this.gridRenderer=new Qt(this),this.barsRenderer=new _t(this),this.labelsRenderer=new Zt(this),this.tooltipRenderer=new Xt(this)}createSVG(){this.svg=this.element.append("svg").attr("id",this.svgSelector).attr("class","lotivis-chart-svg").attr("preserveAspectRatio","xMidYMid meet").attr("viewBox",`0 0 ${this.config.width} ${this.config.height}`)}remove(){this.svg.selectAll("*").remove()}precalculate(){this.datasetController?this.dataView=this.datasetController.getPlotDataview():this.dataView={datasets:[],barsCount:0};let t=this.config.margin,e=this.dataView.labelsCount||0;this.graphWidth=this.config.width-t.left-t.right,this.graphHeight=e*this.config.lineHeight,this.height=this.graphHeight+t.top+t.bottom,this.preferredHeight=this.height,this.svg.attr("viewBox",`0 0 ${this.config.width} ${this.preferredHeight}`),this.sortDatasets(),this.createScales()}draw(){this.backgroundRenderer.render(),this.gridRenderer.render(),this.axisRenderer.renderAxis(),this.barsRenderer.renderBars(),this.labelsRenderer.renderLabels()}update(t,e){this.updateSensible&&"dates-filter"!==e&&(this.remove(),this.precalculate(),this.draw())}createScales(){this.xChart=d3.scaleBand().domain(this.dataView.dates||[]).rangeRound([this.config.margin.left,this.config.width-this.config.margin.right]).paddingInner(.1),this.yChart=d3.scaleBand().domain(this.dataView.labels||[]).rangeRound([this.height-this.config.margin.bottom,this.config.margin.top]).paddingInner(.1),this.xAxisGrid=d3.axisBottom(this.xChart).tickSize(-this.graphHeight).tickFormat(""),this.yAxisGrid=d3.axisLeft(this.yChart).tickSize(-this.graphWidth).tickFormat("")}onSelectDataset(t,e){if(!e||!e.label)return;let s=e.label;1!==this.datasetController.listeners.length&&(this.updateSensible=!1,this.datasetController.setDatasetsFilter([s]),this.updateSensible=!0)}sortDatasets(){switch(this.dataView.datasets=this.dataView.datasets.reverse(),this.sort){case ee:this.dataView.datasets=this.dataView.datasets.sort(((t,e)=>t.label>e.label));break;case se:this.dataView.datasets=this.dataView.datasets.sort(((t,e)=>t.duration<e.duration));break;case ae:this.dataView.datasets=this.dataView.datasets.sort(((t,e)=>t.sum<e.sum));break;case ie:this.dataView.datasets=this.dataView.datasets.sort(((t,e)=>t.earliestDate>e.earliestDate))}}}class oe extends Ft{inject(){super.inject();let t=this.row.append("div");this.showLabelsCheckbox=new I(t),this.showLabelsCheckbox.setText("Labels"),this.showLabelsCheckbox.onClick=function(t){this.chart.config.isShowLabels=t,this.chart.update(),Lt.getInstance().set(Lt.chartShowLabels,t)}.bind(this);let e=this.row.append("div");this.sortDropdown=new $(e),this.sortDropdown.setLabelText("Sort"),this.sortDropdown.setOptions([new b(ee),new b(se),new b(ae),new b(ie)]),this.sortDropdown.setOnChange(function(t){this.chart.sort=t,this.chart.update()}.bind(this))}willShow(){this.showLabelsCheckbox.setChecked(this.chart.config.isShowLabels),this.sortDropdown.setSelectedOption(this.chart.sort)}}E.prototype.addListener=function(t){return this.listeners||(this.listeners=[]),t.update?this.listeners.includes(t)?C(`[lotivis]  Attempt to add listener twice (${t}).`):(this.listeners.push(t),void t.update(this,E.NotificationReason.registration)):C("Listener unqualified.")},E.prototype.removeListener=function(t){if(!this.listeners)return C("No listeners property.");let e=this.listeners.indexOf(t);if(-1===e)return C("Listener not registered: "+t);this.listeners=this.listeners.splice(e,1)},E.prototype.notifyListeners=function(t=E.NotificationReason.none){if(this.listeners)for(let e=0;e<this.listeners.length;e++){let s=this.listeners[e];s.update?(C("listener: "+s),console.timeStamp("will update "+s),s.update(this,t),console.timeStamp("did update "+s)):C("Listener unqualified.")}},E.prototype.register=function(t){if(Array.isArray(t))for(let e=0;e<t.length;e++){let s=t[e];s.setDatasetsController&&s.setDatasetsController(this)}},E.prototype.resetFilters=function(t=!0){this.locationFilters=[],this.dateFilters=[],this.datasetFilters=[],this.calculateSelection(),t&&this.notifyListeners(E.NotificationReason.resetFilters)},E.prototype.setLocationsFilter=function(t){let e=t.map((t=>String(t))).filter((t=>t.length>0));if(H(this.locationFilters,e))return C("[lotivis]  Location filters not changed.");this.locationFilters=e,this.calculateSelection(),this.notifyListeners(E.NotificationReason.filterLocations)},E.prototype.setDatesFilter=function(t){let e=t.map((t=>String(t))).filter((t=>t.length>0));if(H(this.dateFilters,e))return C("[lotivis]  Date filters not changed.");this.dateFilters=e,this.calculateSelection(),this.notifyListeners(E.NotificationReason.filterDates)},E.prototype.setDatasetsFilter=function(t){let e=t.map((t=>String(t))).filter((t=>t.length>0));if(H(this.datasetFilters,e))return C("[lotivis]  Dataset filters not changed.");this.datasetFilters=e,this.calculateSelection(),this.notifyListeners(E.NotificationReason.filterDataset)},E.prototype.toggleDataset=function(t,e=!0){this.datasets.forEach((e=>{e.label===t&&(e.isEnabled=!e.isEnabled)})),e&&this.notifyListeners("dataset-toggle")},E.prototype.enableAllDatasets=function(){this.datasets.forEach((t=>t.isEnabled=!0)),this.notifyListeners("dataset-enable-all")},E.prototype.enabledFlatData=function(){return st(this.enabledDatasets())},E.prototype.enabledLabels=function(){return nt(this.enabledDatasets())},E.prototype.enabledStacks=function(){return ot(this.enabledDatasets())},E.prototype.enabledDates=function(){return lt(this.enabledDatasets())},E.prototype.enabledDatasets=function(){let t=S(this.datasets).filter((t=>!0===t.isEnabled));if(this.datasetFilters&&this.datasetFilters.length>0&&(t=t.filter((t=>this.datasetFilters.includes(t.label)))),this.locationFilters&&this.locationFilters.length>0){let e=this.locationFilters;t=t.map((function(t){return t.data=t.data.filter((t=>e.includes(String(t.location))))||[],t}))}if(this.dateFilters&&this.dateFilters.length>0){let e=this.dateFilters;t=t.map((function(t){return t.data=t.data.filter((t=>e.includes(String(t.date))))||[],t}))}return t.filter((t=>t.data.length>0))},E.prototype.setDataset=function(t){this.cache.invalidate(),this.setDatasets([t])},E.prototype.setDatasets=function(t){this.cache.invalidate(),this.originalDatasets=t,this.datasets=S(t),z(t),this.datasetsDidChange()},E.prototype.addDataset=function(t){this.cache.invalidate(),this.addDatasets([t])},E.prototype.addDatasets=function(t){if(this.datasets&&Array.isArray(this.datasets)&&t&&Array.isArray(t)){if(this.datasets.find((e=>e.label===t.label)))throw new Error(`DatasetsController already contains a dataset with the same label (${t.label}).`);this.cache.invalidate(),t.forEach((t=>this.datasets.push(t))),this.datasetsDidChange(),this.notifyListeners(E.NotificationReason.datasetsUpdate)}},E.prototype.removeDataset=function(t){this.cache.invalidate(),this.removeDatasets([t])},E.prototype.removeDatasets=function(t){this.datasets&&Array.isArray(this.datasets)&&t&&Array.isArray(t)&&(this.cache.invalidate(),t.forEach(function(t){let e=this.datasets.find((e=>e.label===t));if(!e)return;let s=this.datasets.indexOf(e);s<0||(this.datasets=this.datasets.splice(s,1))}.bind(this)),this.datasetsDidChange())};class le{constructor(t,s){let a=t,i={},r={};for(let t=0;t<s.length;t++){let n=s[t],o=a.filter((function(t){return t.label===n||t.stack===n})),l=e.colorsForStack(t,o.length);r[n]=l;for(let t=0;t<o.length;t++)i[o[t].label]=l[t]}this.colorForDataset=function(t){return i[t]||e.defaultTint},this.colorForStack=function(t){return r[t][0]||e.defaultTint},this.colorsForStack=function(t){return r[t]||[]}}}function he(t,e,s){return ot(e).map((function(a){let i=e.filter((function(t){return t.stack===a||t.label===a})),r=i.map((t=>t.label)),n=i.map((e=>t.getColorForDataset(e.label))),o=d3.stack().keys(r)(s);return o.label=a,o.stack=a,o.colors=n,o}))}function ce(t,e){let s=S(t);for(let t=0;t<s.length;t++){let a=s[t],i=a.data;a.data=de(i,e),s[t]=a}return s}function de(t,e){if(!t||t.length<=e)return t;if(e<=1)return t;let s=F(S(t)),a=[];for(;s.length>0;){let t=s.splice(0,e),i=t.first()||{},r=t.last()||{},n={};n.dataset=i.dataset,n.label=i.label,n.stack=i.stack,n.date=i.date,n.date=i.date,n.from=i.date,n.till=r.date,n.value=O(t),a.push(n)}return a}E.prototype.getSelection=function(){return this.selection},E.prototype.calculateSelection=function(){let t=this.enabledDatasets(),e=st(t);this.selection={labels:nt(t),stacks:ot(t),dates:ct(e),locations:dt(e),datasets:t,flatData:e}},E.prototype.calculateAdditionalData=function(){let t=this.dateAccess;this.datasets=S(this.datasets).sort(((t,e)=>t.label>e.label)),this.datasets.forEach((function(e){e.isEnabled=!0,e.data.forEach((function(e){e.dateNumeric=t(e.date)})),e.data=e.data.sort(((t,e)=>t.dateNumeric-e.dateNumeric))})),this.flatData=st(this.datasets),this.labels=nt(this.datasets),this.stacks=ot(this.datasets),this.dates=lt(this.datasets).sort(((e,s)=>t(e)-t(s))),this.locations=ht(this.datasets),this.datasetsColorsController=new le(this.datasets,this.stacks)},E.prototype.datasetsDidChange=function(){this.datasets&&Array.isArray(this.datasets)?(this.calculateAdditionalData(),this.calculateSelection(),this.notifyListeners(E.NotificationReason.datasetsUpdate)):C("[lotivis]  No datasets.")},Array.prototype.first=function(){return this[0]},Array.prototype.last=function(){return this[this.length-1]},E.prototype.getCached=function(t){let e=this.cache.getDataview(t,this.locationFilters,this.dateFilters,this.datasetFilters);return C("using cached data view: "+t),e},E.prototype.setCached=function(t,e){return this.cache.setDataview(t,e,this.locationFilters,this.dateFilters,this.datasetFilters)},E.prototype.getDateDataview=function(t){let e=this.getCached("date");if(e)return e;this.dateAccess;let s=S(this.datasets),a=S(this.enabledDatasets()||s),i={},r=t||1;return i.groupSize=r,r<=1?(i.datasets=s,i.enabledDatasets=a):(s=ce(s,r),a=ce(a,r),i.datasets=s),i.dateToItemsRelation=mt(s),i.dateToItemsRelationPresented=mt(a),i.datasetStacks=he(this,s,i.dateToItemsRelation),i.datasetStacksPresented=he(this,a,i.dateToItemsRelationPresented),i.max=d3.max(i.datasetStacksPresented,(function(t){return d3.max(t,(function(t){return d3.max(t.map((t=>t[1])))}))})),i.dates=lt(a),i.enabledStacks=this.enabledStacks(),this.setCached(i,"date"),i},E.prototype.getDateDataviewCombinedStacks=function(t){this.dateAccess;let e=S(this.datasets),s=S(this.enabledDatasets()||e),a={},i=t||1;return e.forEach((function(t){t.label=t.stack||t.label})),s.forEach((function(t){t.label=t.stack||t.label})),e=tt(R(st(e))),s=tt(R(st(s))),a.groupSize=i,i<=1?(a.datasets=e,a.enabledDatasets=s):(e=ce(e,i),s=ce(s,i),a.datasets=e),a.dateToItemsRelation=mt(e),a.dateToItemsRelationPresented=mt(s),a.datasetStacks=he(this,e,a.dateToItemsRelation),a.datasetStacksPresented=he(this,s,a.dateToItemsRelationPresented),a.max=d3.max(a.datasetStacksPresented,(function(t){return d3.max(t,(function(t){return d3.max(t.map((t=>t[1])))}))})),a.dates=lt(s),a.enabledStacks=this.enabledStacks(),a},E.prototype.getLocationDataview=function(){let t=this.getCached("location");if(t)return t;let e={},s=T(L(this.enabledFlatData()));return e.stacks=this.stacks,e.combinedData=s,e.combinedData.forEach((t=>{t.stack=t.stack||t.label||t.dataset})),this.setCached(e,"location"),e},t.Color=e,t.Button=f,t.Card=j,t.Checkbox=I,t.Component=p,t.Dropdown=$,t.ModalPopup=class extends G{constructor(t){super(t),this.modalBackground.classed("popup-underground",!1).classed("modal-underground",!0)}inject(){super.inject(),this.renderRow()}renderRow(){this.row=this.card.body.append("div").classed("row",!0),this.content=this.row.append("div").classed("col-12 info-box-margin",!0)}loadContent(t){if(!t)return;let e=this.content;d3.text(t).then((function(t){console.log(t),e.html(t)})).catch((function(t){console.log(t)}))}preferredSize(){return{width:800,height:600}}},t.Popup=G,t.RadioGroup=g,t.Option=b,t.Toast=m,t.DatasetsJSONCard=class extends W{constructor(t="datasets-json-card"){Object.getPrototypeOf(t)===Object.prototype&&(t.selector=t.selector||"datasets-json-card"),super(t),this.setTitle("Dataset JSON")}download(t){!function(t,e){K(new Blob([t],{type:"text/json"}),q(e,"json"))}(t,Y(this.datasetsController.getFilename(),"datasets"))}textToDatasets(t){return""===t?[]:JSON.parse(t.trim())}datasetsToText(t){return JSON.stringify(t.datasets,null,2)||""}},t.DatasetCSVCard=class extends W{constructor(t){super(t),this.setTitle("Dataset CSV")}download(t){_(t,Y(this.datasetsController.getFilename(),"datasets"))}textToDatasets(t){return""===t?[]:et(t)}datasetsToText(t){return function(t){let e=st(t),s=["label","stack","value","date","location"].join(",")+"\n";for(let t=0;t<e.length;t++){let a=e[t],i=[];i.push(it(a.dataset||"Unknown")),i.push(it(a.stack||"")),i.push(a.value||"0"),i.push(it(a.date||"")),i.push(it(a.location||"")),s+=i.join(",")+"\n"}return s}(t.datasets)}},t.DatasetCSVDateCard=class extends W{constructor(t){super(t),this.setTitle("Dataset CSV")}download(t){_(t,Y(this.datasetsController.getFilename(),"datasets"))}textToDatasets(t){return""===t?[]:rt(t)}datasetsToText(t){return function(t){let e=mt(t),s=nt(t),a=["date"];for(let t=0;t<s.length;t++)a.push(s[t]);let i=a.join(",")+"\n";for(let t=0;t<e.length;t++){let a=e[t],r=""+a.date;for(let t=0;t<s.length;t++)r+=","+a[s[t]];i+=r+"\n"}return i}(t.datasets)}},t.DataviewCard=bt,t.DataviewDateCard=class extends bt{getTitle(){return"Dataview Date"}getDataview(){return this.datasetsController.getDateDataview()}},t.DataviewPlotCard=class extends bt{getTitle(){return"Dataview Plot"}getDataview(){return this.datasetsController.getPlotDataview()}},t.DataviewMapCard=class extends bt{getTitle(){return"Dataview Map"}getDataview(){return this.datasetsController.getLocationDataview()}},t.DataviewFlatCard=class extends bt{getTitle(){return"Flat Data"}getDataview(){return this.datasetsController.flatData}},t.DataviewDatasetsControllerCard=class extends bt{constructor(t){super(t)}datasetsToText(t){return JSON.stringify({labels:this.datasetsController.labels,stacks:this.datasetsController.stacks,dates:this.datasetsController.dates,locations:this.datasetsController.locations,filters:{locations:this.datasetsController.locationFilters,dates:this.datasetsController.dateFilters,datasets:this.datasetsController.datasetFilters},selection:{},datasets:this.datasetsController.datasets,flatData:this.datasetsController.flatData,originalDatasets:this.datasetsController.originalDatasets},null,2)}},t.DataviewDatasetsControllerSelectionCard=class extends bt{constructor(t){super(t)}datasetsToText(t){return JSON.stringify(this.datasetsController.getSelection(),null,2)}},t.UpdatableDataviewCard=M,t.EditableDataviewCard=W,t.DateChart=Rt,t.DateChartCard=class extends At{constructor(t,e={}){let s=t||e.selector||"date-chart-card";super(s,e),this.selector=s,this.datasets=[],this.injectRadioGroup()}injectChart(){this.chartID=this.selector+"-chart",this.body.attr("id",this.chartID),this.chart=new Rt(this.chartID,this.config)}injectRadioGroup(){this.radioGroup=new g(this.headerCenterComponent),this.radioGroup.onChange=function(t){let e=this.datasets.find((e=>e.label===t));this.setDataset(e)}.bind(this)}updateRadioGroup(){if(!this.datasets)return;let t=this.datasets.map((t=>t.label)).map((t=>new b(t)));this.radioGroup.setOptions(t)}presentSettingsPopupAction(){let t=document.getElementById(this.moreButton.selector),e=new Tt;e.chart=this.chart,e.showUnder(t,"right")}screenshotButtonAction(){let t=Y(this.chart.datasetController.getFilename()||"date-chart","date-chart");X(this.chart.svgSelector,t)}},t.MapChart=Wt,t.MapChartCard=class extends At{constructor(t,e){super(t||"map-chart-card",e)}injectChart(){this.chartID=this.selector+"-chart",this.body.attr("id",this.chartID),this.chart=new Wt(this.chartID,this.config)}screenshotButtonAction(){let t="Unknown";this.chart&&this.chart.datasetController&&(t=this.chart.datasetController.getFilename());let e=Y(t,"map-chart");X(this.chart.svgSelector,e)}presentSettingsPopupAction(){let t=d3.select("body"),e=document.getElementById(this.moreButton.selector),s=new qt(t);s.mapChart=this.chart,s.showUnder(e,"right")}},t.PlotChart=ne,t.PlotChartCard=class extends At{constructor(t,e){super(t||"plot-chart-card",e),this.injectRadioGroup(),this.applyURLParameters(),this.setTitle("Plot")}injectChart(){this.chartID=this.selector+"-chart",this.body.attr("id",this.chartID),this.chart=new ne(this.chartID,this.config)}applyURLParameters(){let t=Lt.getInstance();this.chart.type=t.getString(Lt.chartType,"bar"),this.chart.isShowLabels=t.getBoolean(Lt.chartShowLabels,!1),this.chart.isCombineStacks=t.getBoolean(Lt.chartCombineStacks,!1)}presentSettingsPopupAction(){let t=d3.select("body"),e=document.getElementById(this.moreButton.selector),s=new oe(t);s.chart=this.chart,s.showUnder(e,"right")}screenshotButtonAction(){let t=Y(this.chart.datasetController.getFilename(),"plot-chart");X(this.chart.svgSelector,t)}},t.DatasetController=E,t.parseCSV=et,t.parseCSVDate=rt,t.config=w,t.debug=function(t,e=!1){(C=t?console.log:()=>null)(`[lotivis]  ${t?"En":"Dis"}abled debug mode.`),e&&C("LotivisConfig = "+JSON.stringify(w,null,2))},t.DefaultDateAccess=N,t.FormattedDateAccess=function(t){let e=Date.parse(t);return isNaN(e)&&v(`Received NaN for date "${t}"`),e},t.GermanDateAccess=function(t){let e=String(t).split("."),s=e[0],a=e[1],i=e[2],r=new Date(`${i}-${a}-${s}`);return Number(r)},t.DateWeekAssessor=function(t){switch(t.toLowerCase()){case"sunday":case"sun":return 0;case"monday":case"mon":return 1;case"tuesday":case"tue":return 2;case"wednesday":case"wed":return 3;case"thursday":case"thr":return 4;case"friday":case"fri":return 5;case"saturday":case"sat":return 6;default:return-1}},t.URLParameters=Lt;var ue=t;console.log("[lotivis]  lotivis module loaded."),t.default=ue}));
//# sourceMappingURL=/sm/c5f70b1f10744d6c2a70dbecc628db07aecb579672580e2802766a539585b2e3.map
