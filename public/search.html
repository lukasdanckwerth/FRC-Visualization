<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lotivis@1.0.45/dist/lotivis.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
  <title>FRCV - Search</title>
</head>
<body>

<div class="container">
  <div class="row">
    <div class="col-2">
      <a href="index.html">
        <button class="back-button">
          Back
        </button>
      </a>
    </div>
    <div class="col-8 text-center">
      <h1></h1>
    </div>
    <div class="col-12">
      <div class="card">
        <div class="card-body margin-top margin-bottom">
          <div class="row">
            <div class="col-12 text-center">
              <label for="search-input"></label>
              <input class="form-control form-control-sm"
                     type="text"
                     placeholder="Search Word"
                     id="search-input"
                     list="search-input-data"
                     onkeydown="search(this)">
              <datalist id="search-input-data"></datalist>
            </div>
            <br>
            <br>
            <div class="col-2 text-center">
              <label for="case-sensitivity-dropdown">Case Sens.</label>
              <select id="case-sensitivity-dropdown" onchange="sensitivityDropdownAction(this)">
                <option id="case-insensitive" value="case-insensitive">No</option>
                <option id="case-sensitive" value="case-sensitive">Yes</option>
              </select>
            </div>
            <div class="col-3 text-center">
              <label for="from-dropdown">From</label>
              <select id="from-dropdown" onchange="fromDropdownAction(this)">
                <!-- Year Options Here -->
              </select>
              <label for="till-dropdown">To</label>
              <select id="till-dropdown" onchange="tillDropdownAction(this)">
                <!-- Year Options Here -->
              </select>
            </div>
            <div class="col-2">
              <label for="relative-absolute-dropdown">Rel. / Abs.</label>
              <select id="relative-absolute-dropdown" onchange="relativeAbsoluteAction(this)">
                <option id="relative" value="relative">Rel.</option>
                <option id="absolute" value="absolute">Abs.</option>
              </select>
            </div>
            <div class="col-2">
              <button class="back button-down" onclick="presentInnovationList(this)">
                Innovation List
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6">
      <div id="time-chart-card">
        <!-- Time Chart Here -->
      </div>
      <div id="plot-chart-card">
        <!-- Plot Chart Here -->
      </div>
    </div>
    <div class="col-6">
      <div id="map-chart-card">
        <!-- Map Chart Here -->
      </div>
      <div id="about-card">
        <!-- About Chart Here -->
      </div>
    </div>
    <div class="col-12 text-center">
      <div id="loading">Loading...</div>
    </div>
  </div><!-- Row -->
</div><!-- Container -->

<script src="https://cdn.jsdelivr.net/npm/d3@6.5.0/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lotivis@1.0.45/dist/lotivis.js"></script>
<script src="js/frc.js"></script>
<script>

  // create lotivis components
  let timeChartCard = new lotivis.TimeChartCard('time-chart-card');
  let mapChartCard = new lotivis.MapChartCard('map-chart-card');
  let plotChartCard = new lotivis.PlotChartCard('plot-chart-card');
  let aboutCard = new lotivis.PlotChartCard('about-card');
  let loadingView = document.getElementById('loading');
  let searchField = document.getElementById('search-input');

  let corpus = new frc('');
  mapChartCard.chart.excludedFeatureCodes = ['2A', '2B'];

  // search options;
  let firstYear, lastYear;
  let sensitivity = document.getElementById('case-sensitivity-dropdown').value;
  let relativeAbsolute = 'relative';

  function search(input) {
    if (Object.getPrototypeOf(this.event) === KeyboardEvent.prototype
      && this.event.key !== 'Enter') return;
    let searchText = input.value;

    if (searchText === undefined) {
      return console.log('search text undefined');
    } else if (searchText.trim().length === 0) {
      return console.log('search text too short');
    }

    console.log('firstYear', firstYear);
    console.log('firstYear', firstYear);
    console.log('lastYear', lastYear);
    console.log('sensitivity', sensitivity);
    console.log('relativeAbsolute', relativeAbsolute);

    let datasets = corpus.search(
      searchText,
      firstYear,
      lastYear,
      sensitivity,
      relativeAbsolute
    );

    let controller = new lotivis.FilterableDatasetController(datasets);
    console.log('datasets', datasets);

    timeChartCard.chart.setDatasetController(controller);
    timeChartCard.chart.update();
    mapChartCard.chart.setDatasetController(controller);
    plotChartCard.chart.setDatasetController(controller);

  }

  function presentInnovationList(some) {
    console.log('presentInnovationList', some);
    let body = d3.select('body');
    let popup = new lotivis.Popup(body);
    popup.showUnder(some);

    d3
      .text('/assets/innovation-list.txt')
      .then(function (text) {
        let lines = text.split('\n').filter(line => line.length > 0);
        popup
          .card
          .body
          .classed('margin-top margin-left margin-bottom margin-right menu', true)
          .style('overflow', 'scroll')
          .append('div')
          .selectAll('a')
          .data(lines)
          .enter()
          .append('a')
          .style('cursor', 'pointer')
          .html(line => `<nobr>${line}</nobr>`)
          .on('click', function (event, line) {
            console.log('line', line);
            let corrected = line.replaceAll(';',',');
            searchField.value = corrected;
            search(searchField);
            popup.dismiss();
          });
      });
  }

  function sensitivityDropdownAction(some) {
    sensitivity = some.value;
    search(searchField);
  }

  function fromDropdownAction(some) {
    firstYear = Number(some.value);
    search(searchField);
  }

  function tillDropdownAction(some) {
    lastYear = Number(some.value);
    search(searchField);
  }

  function relativeAbsoluteAction(some) {
    relativeAbsolute = some.value;
    search(searchField);
  }

  function fillYearDropdowns() {
    let html = '';
    firstYear = corpus.getEarliestYear();
    lastYear = corpus.getLatestYear();

    for (let year = firstYear; year <= lastYear; year++) {
      html += `<option value="${year}">${year}</option>`;
    }

    let fromDropdown = document.getElementById('from-dropdown');
    let tillDropdown = document.getElementById('till-dropdown');
    fromDropdown.innerHTML = html;
    tillDropdown.innerHTML = html;
    tillDropdown.value = `${lastYear}`;
  }

  d3.json('/assets/Departements.geojson')
    .then(function (geoJSON) {
      mapChartCard.chart.setGeoJSON(new lotivis.GeoJson(geoJSON));
    });

  d3.json('/corpus')
    .then(function (corpusJSON) {
      corpus = new frc(corpusJSON);
      fillYearDropdowns();
      loadingView.style.display = 'none';
    })
    .catch(function (error) {
      console.error(error);
    });

</script>

</body>
</html>
